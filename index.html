<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ID / PIN</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5eaf2;
      --head:#f1f5f9;

      --primary:#0b1220;
      --primaryText:#ffffff;

      --dangerBg:#fde2e2;
      --dangerText:#b42318;

      --chip:#eef2ff;
      --chipLine:#c7d2fe;

      --focus:#c7d2fe;

      /* ã‚³ãƒ”ãƒ¼å¼·èª¿ï¼ˆè–„ã„é’ï¼‰ */
      --copiedBg:#dbeafe;
      --copiedLine:#93c5fd;

      /* #åˆ— èƒŒæ™¯æ•°å­—ï¼ˆè¦‹ã‚„ã™ãæ¿ƒãå¤‰æ›´ï¼‰ */
      --ghostAlpha:0.5;    /* â† 0.22ã‹ã‚‰0.5ã¸å¤‰æ›´ */

      /* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…ï¼ˆIDã‚’æœ€ã‚‚åºƒãã€PINã‚’æ¬¡ã«åºƒãï¼‰ */
      --colNum:48px;       /* ç‹­ã */
      --colBtn:54px;       /* ãƒœã‚¿ãƒ³å¹… */
      --colId:1.8fr;       /* æœ€ã‚‚åºƒã */
      --colPin:1.2fr;      /* æ¬¡ã«åºƒã */
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      -webkit-font-smoothing:antialiased;
      overscroll-behavior-y:contain;
    }
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      background:rgba(245,247,251,.95);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      padding:8px 12px 6px; /* ä½™ç™½ã‚’å°‘ã—ç¸®å° */
    }
    .toprow{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .btnrow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:8px 12px; /* å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      letter-spacing:.01em;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:scale(.98);}
    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }
    .btn.danger{
      background:var(--dangerBg);
      color:var(--dangerText);
      border-color:transparent;
      font-weight:800;
    }
    .btn.icon{
      width:40px;height:40px;
      padding:0;
      display:grid;
      place-items:center;
      border-radius:12px;
      background:#eef2ff;
      border:1px solid #dbeafe;
      font-size:18px;
    }
    .btn:disabled{
      opacity:.45;
      filter:grayscale(.2);
      transform:none;
    }
    
    /* ã‚¿ã‚¤ãƒˆãƒ«è¡Œã®ä½™ç™½ã‚’å‰Šæ¸› */
    .titleline{
      margin-top:4px; 
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:16px;
      font-weight:900;
    }
    .count{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
    }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®ä½™ç™½ã‚’å‰Šæ¸› */
    .content{
      width:min(980px,100%);
      margin:0 auto;
      padding:6px 12px 96px; /* ä¸Šéƒ¨paddingã‚’ç¸®å° */
      display:flex;
      flex-direction:column;
      gap:8px; /* ã‚«ãƒ¼ãƒ‰é–“ã®éš™é–“ã‚‚å°‘ã—è©°ã‚ã‚‹ */
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }

    /* å…¥åŠ›ã‚·ãƒ¼ãƒˆï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ */
    .pasteWrap{
      display:flex;
      flex-direction:column;
      gap:8px; /* éš™é–“èª¿æ•´ */
    }
    .pasteLabel{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:4px;
    }
    textarea{
      width:100%;
      min-height:100px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      line-height:1.4;
      outline:none;
      background:#fbfdff;
      -webkit-overflow-scrolling:touch;
    }
    textarea:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.35);
    }
    .actions2{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .actions2 .btn{
      flex:1;
      min-width:140px;
      padding:12px 14px;
      border-radius:14px;
      font-size:16px;
      font-weight:900;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
    .tableCard{
      padding:0;
      overflow:hidden;
    }
    .thead{
      background:var(--head);
      border-bottom:1px solid var(--line);
    }
    /* ã‚°ãƒªãƒƒãƒ‰å®šç¾©ï¼š# | ID | Btn | PIN | Btn */
    .tr{
      display:grid;
      grid-template-columns: var(--colNum) var(--colId) var(--colBtn) var(--colPin) var(--colBtn);
      align-items:center;
      gap:0;
      padding:8px 8px; /* å°‘ã—è©°ã‚æ°—å‘³ã« */
      border-bottom:1px solid var(--line);
    }
    .thead .tr{
      padding:8px 8px;
      font-weight:900;
      color:#334155;
      font-size:13px;
      text-align:center; /* ãƒ˜ãƒƒãƒ€ã¯ä¸­å¤®å¯„ã› */
    }
    /* ãƒ˜ãƒƒãƒ€ã®æ–‡å­—ä½ç½®èª¿æ•´ */
    .thead .tr > div:nth-child(2) { text-align:left; padding-left:4px; } /* ID */
    .thead .tr > div:nth-child(4) { text-align:left; padding-left:4px; } /* PIN */

    .tbody .tr{
      background:var(--card);
    }
    .tbody .tr:last-child{border-bottom:none;}

    /* #åˆ—ï¼ˆãƒãƒƒã‚¸ + èƒŒæ™¯ã‚´ãƒ¼ã‚¹ãƒˆæ•°å­—ï¼‰ */
    .numCell{
      position:relative;
      height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .numBadge{
      width:28px;height:28px; /* å°‘ã—å°ã•ã */
      display:grid;
      place-items:center;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chipLine);
      font-weight:900;
      font-size:13px;
      color:#0f172a;
      z-index:2;
    }
    .ghost{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:1000;
      font-size:32px;
      letter-spacing:-.04em;
      z-index:1;
      pointer-events:none;
      opacity:var(--ghostAlpha); /* æ¿ƒãè¨­å®š */
      transform:translateY(1px);
      filter:saturate(1.2);
    }

    /* å€¤ã‚»ãƒ«ï¼ˆå…¥åŠ›/è¡¨ç¤ºï¼‰ */
    .valCell{
      padding:0 4px;
      min-width:0;
    }
    .field{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      padding:8px 6px;
      border-radius:10px;
      font-size:18px; /* å°‘ã—å°ã•ãã—ã¦ä¸€è¦§æ€§ã‚’é«˜ã‚ã‚‹ */
      font-weight:900;
      outline:none;
      min-width:0;
    }
    .field::placeholder{color:#cbd5e1;font-weight:800;}
    .field:focus{
      background:#f8fafc;
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(199,210,254,.35);
    }

    /* ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå…¥åŠ›ã‚·ãƒ¼ãƒˆã®ã¿ï¼‰ */
    .copyBtn{
      width:40px;height:40px;
      margin:0 auto;
      border-radius:12px;
      border:1px solid #dbeafe;
      background:#f0f5ff; /* å°‘ã—è‰²ã‚’æ¿ƒã */
      display:grid;
      place-items:center;
      font-size:18px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, background .15s ease;
      cursor:pointer;
    }
    .copyBtn:active{transform:scale(.92); background:#dbeafe;}
    .copyBtn.disabled{
      opacity:.3;
      filter:grayscale(1);
      pointer-events:none;
      border-color:transparent;
      background:transparent;
    }

    /* ã‚³ãƒ”ãƒ¼ã‚·ãƒ¼ãƒˆï¼šãƒœã‚¿ãƒ³ç„¡ã—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .copyMode .tr{
      /* ã‚³ãƒ”ãƒ¼ã‚·ãƒ¼ãƒˆã¯ãƒœã‚¿ãƒ³åˆ—ãªã— */
      grid-template-columns: var(--colNum) var(--colId) var(--colPin);
    }
    .copyMode .copyTap{
      border-radius:12px;
      padding:10px 8px;
      font-size:20px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:background .12s ease, box-shadow .12s ease;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .copyMode .copyTap:active{
      background:#eef2ff;
    }

    /* ã©ã®ã‚»ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸã‹ã®å¼·èª¿ */
    .copied{
      background:var(--copiedBg) !important;
      box-shadow:inset 0 0 0 2px var(--copiedLine);
    }

    /* ä¸‹ãƒŠãƒ“ */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:8px 12px 18px;
      background:rgba(245,247,251,.95);
      backdrop-filter:saturate(180%) blur(12px);
      border-top:1px solid var(--line);
      z-index:40;
    }
    .navInner{
      width:min(980px,100%);
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .navBtn{
      border-radius:18px;
      padding:14px 16px;
      font-size:18px;
      font-weight:1000;
      border:1px solid var(--line);
      background:var(--card);
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .navBtn.active{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:90px;
      background:#0b1220;
      color:white;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      z-index:60;
      max-width:min(92vw,520px);
      text-align:center;
      font-size:14px;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    @media (max-width:520px){
      :root{
        --colNum:44px; /* ã‚¹ãƒãƒ›ã§ã‚ˆã‚Šç‹­ã */
        --colBtn:48px;
      }
      .field{font-size:18px;}
      .copyMode .copyTap{font-size:18px;}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div class="btnrow">
        <button class="btn primary" id="btnSave">ä¿å­˜</button>
        <button class="btn" id="btnLoad">èª­è¾¼</button>
        <button class="btn danger" id="btnClear">å…¨å‰Šé™¤</button>
      </div>

      <div class="btnrow">
        <button class="btn icon" id="btnUndo" title="æˆ»ã‚‹" aria-label="æˆ»ã‚‹">â†</button>
        <button class="btn icon" id="btnRedo" title="é€²ã‚€" aria-label="é€²ã‚€">â†’</button>
      </div>
    </div>

    <div class="titleline">
      <div class="title" id="screenTitle">å…¥åŠ›</div>
      <div class="count" id="countLabel">ä»¶æ•°ï¼š0</div>
    </div>
  </div>

  <div class="content" id="content"></div>

  <div class="nav">
    <div class="navInner">
      <div class="navBtn active" id="navInput">å…¥åŠ›</div>
      <div class="navBtn" id="navCopy">ã‚³ãƒ”ãƒ¼</div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>
</div>

<script>
(() => {
  "use strict";

  // =========================
  // è¨­å®š
  // =========================
  const MAX_ROWS = 200;
  const LS_KEY_DATA = "idpin_data_v4"; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰ãˆã¦ãŠã
  const LS_KEY_HIST = "idpin_hist_v4";

  // =========================
  // çŠ¶æ…‹
  // =========================
  const state = {
    screen: "input", // "input" | "copy"
    rows: [],
    history: { undo: [], redo: [] },
    lastCopiedEl: null,
    lastCopiedTimer: null,
  };

  function makeEmptyRows(){
    const a = [];
    for(let i=0;i<MAX_ROWS;i++){
      a.push({ id:"", pin:"", editCount:0, lastCommittedId:"" });
    }
    return a;
  }

  // =========================
  // DOM
  // =========================
  const $ = (sel, root=document) => root.querySelector(sel);
  const content = $("#content");
  const screenTitle = $("#screenTitle");
  const countLabel = $("#countLabel");
  const toast = $("#toast");
  const btnSave = $("#btnSave");
  const btnLoad = $("#btnLoad");
  const btnClear = $("#btnClear");
  const btnUndo = $("#btnUndo");
  const btnRedo = $("#btnRedo");
  const navInput = $("#navInput");
  const navCopy  = $("#navCopy");

  // =========================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================
  function activeCount(){
    return state.rows.filter(r => (r.id || r.pin)).length;
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(state._toastTimer);
    state._toastTimer = setTimeout(() => toast.classList.remove("show"), 900);
  }

  async function copyText(text){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  }

  function setCopiedHighlight(el){
    if(state.lastCopiedEl && state.lastCopiedEl !== el){
      state.lastCopiedEl.classList.remove("copied");
    }
    el.classList.add("copied");
    state.lastCopiedEl = el;
    clearTimeout(state.lastCopiedTimer);
    state.lastCopiedTimer = setTimeout(() => {
      if(state.lastCopiedEl){
        state.lastCopiedEl.classList.remove("copied");
        state.lastCopiedEl = null;
      }
    }, 700);
  }

  function ghostColor(editCount){
    const palette = [
      "#2563eb", "#7c3aed", "#db2777", "#ea580c",
      "#16a34a", "#0891b2", "#b45309", "#334155"
    ];
    return palette[Math.abs(editCount) % palette.length];
  }

  function deepCloneRows(rows){
    return rows.map(r => ({...r}));
  }

  function pushHistory(reason){
    state.history.undo.push({
      t: Date.now(),
      reason,
      rows: deepCloneRows(state.rows)
    });
    state.history.redo = [];
    syncUndoRedoButtons();
    saveHistoryToLS();
  }

  function applySnapshot(snapshot, from){
    state.rows = deepCloneRows(snapshot.rows);
    syncUndoRedoButtons();
    render();
    showToast(from === "undo" ? "æˆ»ã—ã¾ã—ãŸ" : "é€²ã‚ã¾ã—ãŸ");
  }

  function saveHistoryToLS(){
    try{
      const slim = {
        undo: state.history.undo.slice(-60),
        redo: state.history.redo.slice(-60)
      };
      localStorage.setItem(LS_KEY_HIST, JSON.stringify(slim));
    }catch(e){}
  }

  function loadHistoryFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_HIST);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && Array.isArray(obj.undo)){
        state.history.undo = obj.undo;
        state.history.redo = obj.redo || [];
      }
    }catch(e){}
  }

  function syncUndoRedoButtons(){
    btnUndo.disabled = state.history.undo.length === 0;
    btnRedo.disabled = state.history.redo.length === 0;
  }

  // =========================
  // ä¿å­˜/èª­è¾¼
  // =========================
  function saveToLS(){
    try{
      const payload = { v:4, savedAt: Date.now(), rows: deepCloneRows(state.rows) };
      localStorage.setItem(LS_KEY_DATA, JSON.stringify(payload));
      showToast("ä¿å­˜ã—ã¾ã—ãŸ");
    }catch(e){ showToast("ä¿å­˜å¤±æ•—"); }
  }

  function loadFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if(!raw){ showToast("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
      const payload = JSON.parse(raw);
      if(!payload || !Array.isArray(payload.rows)){ showToast("èª­è¾¼å¤±æ•—"); return; }
      pushHistory("load");
      state.rows = makeEmptyRows();
      for(let i=0;i<Math.min(MAX_ROWS, payload.rows.length);i++){
        const r = payload.rows[i];
        state.rows[i].id = r.id ?? "";
        state.rows[i].pin = r.pin ?? "";
        state.rows[i].editCount = r.editCount ?? 0;
        state.rows[i].lastCommittedId = r.lastCommittedId ?? state.rows[i].id;
      }
      render();
      showToast("èª­è¾¼ã—ã¾ã—ãŸ");
    }catch(e){ showToast("èª­è¾¼å¤±æ•—"); }
  }

  function clearAll(){
    pushHistory("clear");
    state.rows = makeEmptyRows();
    render();
    showToast("å…¨å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  // =========================
  // å…¥åŠ›å‡¦ç†
  // =========================
  function applyPasted(text){
    const lines = (text || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const parsed = [];
    for(const line of lines){
      const parts = line.split(/\s+/);
      if(parts[0] || parts[1]) parsed.push({id:parts[0]||"", pin:parts[1]||""});
    }
    pushHistory("apply_paste");
    state.rows = makeEmptyRows();
    for(let i=0;i<Math.min(MAX_ROWS, parsed.length);i++){
      state.rows[i].id = parsed[i].id;
      state.rows[i].pin = parsed[i].pin;
      state.rows[i].lastCommittedId = parsed[i].id;
    }
    render();
    showToast("åæ˜ ã—ã¾ã—ãŸ");
  }

  function buildTSV(){
    return state.rows.filter(r => r.id || r.pin).map(r => `${r.id}\t${r.pin}`).join("\n");
  }
  async function copyTSV(){
    const tsv = buildTSV();
    if(!tsv){ showToast("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
    const ok = await copyText(tsv);
    showToast(ok ? "TSVã‚³ãƒ”ãƒ¼å®Œäº†" : "å¤±æ•—");
  }

  function commitIdEdit(rowIndex, newId){
    const r = state.rows[rowIndex];
    if(newId !== (r.lastCommittedId ?? "")){
      r.editCount = (r.editCount ?? 0) + 1;
      r.lastCommittedId = newId;
    }
  }

  function attachSelectAllBehavior(inputEl){
    inputEl.addEventListener("pointerdown", () => { inputEl.dataset.sel = "1"; }, {passive:true});
    inputEl.addEventListener("focus", () => {
      if(inputEl.dataset.sel === "1"){
        requestAnimationFrame(() => {
          try{ inputEl.setSelectionRange(0, inputEl.value.length); }catch(e){}
          inputEl.dataset.sel = "0";
        });
      }
    });
  }

  function undo(){ if(state.history.undo.length){
    state.history.redo.push({ t:Date.now(), reason:"redo", rows:deepCloneRows(state.rows) });
    applySnapshot(state.history.undo.pop(), "undo");
  }}
  function redo(){ if(state.history.redo.length){
    state.history.undo.push({ t:Date.now(), reason:"undo", rows:deepCloneRows(state.rows) });
    applySnapshot(state.history.redo.pop(), "redo");
  }}

  // =========================
  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  // =========================
  function render(){
    screenTitle.textContent = (state.screen === "input") ? "å…¥åŠ›" : "ã‚³ãƒ”ãƒ¼";
    countLabel.textContent = `ä»¶æ•°ï¼š${activeCount()}`;
    navInput.classList.toggle("active", state.screen === "input");
    navCopy.classList.toggle("active", state.screen === "copy");

    content.innerHTML = "";
    content.appendChild(state.screen === "input" ? renderInputScreen() : renderCopyScreen());
  }

  function renderInputScreen(){
    const wrap = document.createElement("div");
    wrap.className = "pasteWrap";

    // è²¼ã‚Šä»˜ã‘ã‚¨ãƒªã‚¢
    const c1 = document.createElement("div");
    c1.className = "card";
    c1.innerHTML = `
      <div class="pasteLabel">å…¥åŠ›ï¼ˆè²¼ã‚Šä»˜ã‘ â†’ åæ˜ ï¼‰</div>
      <textarea id="pasteArea"></textarea>
      <div class="actions2">
        <button class="btn primary" id="btnApply">è²¼ã‚Šä»˜ã‘åæ˜ </button>
        <button class="btn" id="btnCopyTSV">å…¨ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼(TSV)</button>
      </div>
    `;
    wrap.appendChild(c1);

    // ãƒ†ãƒ¼ãƒ–ãƒ«
    const table = document.createElement("div");
    table.className = "card tableCard";

    // ãƒ˜ãƒƒãƒ€ï¼š# | ID | Btn | PIN | Btn
    const thead = document.createElement("div");
    thead.className = "thead";
    thead.innerHTML = `
      <div class="tr">
        <div>#</div>
        <div>ID</div>
        <div></div>
        <div>PIN</div>
        <div></div>
      </div>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("div");
    tbody.className = "tbody";

    for(let i=0;i<MAX_ROWS;i++){
      const r = state.rows[i];
      const tr = document.createElement("div");
      tr.className = "tr";

      // #
      const num = document.createElement("div");
      num.className = "numCell";
      num.innerHTML = `
        <div class="ghost" style="color:${ghostColor(r.editCount)}">${r.editCount}</div>
        <div class="numBadge">${i+1}</div>
      `;

      // ID
      const idCell = document.createElement("div");
      idCell.className = "valCell";
      const idInput = document.createElement("input");
      idInput.className = "field";
      idInput.value = r.id || "";
      idInput.dataset.role = "id";
      attachSelectAllBehavior(idInput);
      idCell.appendChild(idInput);

      // CopyBtn (ID)
      const idCopy = document.createElement("div");
      idCopy.className = "copyBtn";
      idCopy.innerHTML = "ğŸ“‹";
      if(!r.id) idCopy.classList.add("disabled");

      // PIN
      const pinCell = document.createElement("div");
      pinCell.className = "valCell";
      const pinInput = document.createElement("input");
      pinInput.className = "field";
      pinInput.value = r.pin || "";
      attachSelectAllBehavior(pinInput);
      pinCell.appendChild(pinInput);

      // CopyBtn (PIN)
      const pinCopy = document.createElement("div");
      pinCopy.className = "copyBtn";
      pinCopy.innerHTML = "ğŸ“‹";
      if(!r.pin) pinCopy.classList.add("disabled");

      tr.appendChild(num);
      tr.appendChild(idCell);
      tr.appendChild(idCopy);
      tr.appendChild(pinCell);
      tr.appendChild(pinCopy);
      tbody.appendChild(tr);

      // ã‚¤ãƒ™ãƒ³ãƒˆ
      idInput.onblur = () => {
        const nv = idInput.value.trim();
        if(nv !== (state.rows[i].id||"")){
          pushHistory("edit_id");
          state.rows[i].id = nv;
          commitIdEdit(i, nv);
          render(); // å†æç”»(ghostæ›´æ–°ã®ãŸã‚)
        }
      };
      pinInput.onblur = () => {
        const nv = pinInput.value.trim();
        if(nv !== (state.rows[i].pin||"")){
          pushHistory("edit_pin");
          state.rows[i].pin = nv;
          render();
        }
      };
      idCopy.onclick = async () => {
        if(await copyText(r.id)) { setCopiedHighlight(idCell); showToast("IDã‚³ãƒ”ãƒ¼"); }
      };
      pinCopy.onclick = async () => {
        if(await copyText(r.pin)) { setCopiedHighlight(pinCell); showToast("PINã‚³ãƒ”ãƒ¼"); }
      };
    }
    table.appendChild(tbody);
    wrap.appendChild(table);

    // ã‚¤ãƒ™ãƒ³ãƒˆå‰²ã‚Šå½“ã¦
    c1.querySelector("#btnApply").onclick = () => applyPasted(c1.querySelector("#pasteArea").value);
    c1.querySelector("#btnCopyTSV").onclick = copyTSV;

    return wrap;
  }

  function renderCopyScreen(){
    const wrap = document.createElement("div");
    wrap.className = "copyMode";
    
    const rows = state.rows.map((r,i)=>({...r,i})).filter(r => r.id || r.pin);
    if(!rows.length){
      wrap.innerHTML = `<div class="card" style="text-align:center;padding:20px;color:#64748b;font-weight:900">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return wrap;
    }

    const table = document.createElement("div");
    table.className = "card tableCard";
    table.innerHTML = `<div class="thead"><div class="tr"><div>#</div><div>ID</div><div>PIN</div></div></div>`;
    
    const tbody = document.createElement("div");
    tbody.className = "tbody";

    rows.forEach(x => {
      const tr = document.createElement("div");
      tr.className = "tr";
      
      const num = document.createElement("div");
      num.className = "numCell";
      num.innerHTML = `
        <div class="ghost" style="color:${ghostColor(x.editCount)}">${x.editCount}</div>
        <div class="numBadge">${x.i+1}</div>
      `;

      const idTap = document.createElement("div");
      idTap.className = "copyTap";
      idTap.textContent = x.id;
      idTap.onclick = async () => {
        if(await copyText(x.id)){ setCopiedHighlight(idTap); showToast("IDã‚³ãƒ”ãƒ¼"); }
      };

      const pinTap = document.createElement("div");
      pinTap.className = "copyTap";
      pinTap.textContent = x.pin;
      pinTap.onclick = async () => {
        if(await copyText(x.pin)){ setCopiedHighlight(pinTap); showToast("PINã‚³ãƒ”ãƒ¼"); }
      };

      tr.appendChild(num);
      tr.appendChild(idTap);
      tr.appendChild(pinTap);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  // Init
  btnSave.onclick = saveToLS;
  btnLoad.onclick = loadFromLS;
  btnClear.onclick = clearAll;
  btnUndo.onclick = undo;
  btnRedo.onclick = redo;
  navInput.onclick = () => { state.screen="input"; render(); };
  navCopy.onclick = () => { state.screen="copy"; render(); };

  loadHistoryFromLS();
  // è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
  try{
    const raw = localStorage.getItem(LS_KEY_DATA);
    if(raw) loadFromLS(); else render();
  }catch(e){ render(); }

})();
</script>
</body>
</html>
