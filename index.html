<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ID / PIN（入力＆コピー）</title>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6eaf2;
      --head:#f1f5f9;

      --btn:#0b1220;
      --btnText:#fff;
      --btn2:#eef2ff;
      --btn2Text:#1e293b;
      --danger:#ffebee;
      --dangerText:#b91c1c;

      --accent:#2563eb;

      /* コピー時の強調（薄い青） */
      --copiedBg:#dbeafe;   /* 薄い青 */
      --copiedBorder:#60a5fa;

      /* #背景数字（もう少し濃く） */
      --ghostOpacity:0.22;  /* ←ここが濃さ。0.18→0.22に上げた */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overscroll-behavior-y:contain;
      -webkit-tap-highlight-color:transparent;
    }

    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:14px 14px 92px;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:5;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(160%) blur(8px);
      padding:10px 0 10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .leftBtns, .rightBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid transparent;
      background:var(--btn);
      color:var(--btnText);
      border-radius:14px;
      padding:10px 14px;
      font-weight:700;
      font-size:15px;
      line-height:1;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      user-select:none;
      touch-action:manipulation;
    }
    .btn:active{ transform:translateY(1px); }

    .btn.secondary{
      background:var(--btn2);
      color:var(--btn2Text);
      border-color:#dbe3ff;
      box-shadow:none;
    }
    .btn.danger{
      background:var(--danger);
      color:var(--dangerText);
      border-color:#ffd1d7;
      box-shadow:none;
    }

    .btn.icon{
      width:44px;
      height:44px;
      border-radius:14px;
      padding:0;
      display:grid;
      place-items:center;
      font-size:18px;
      font-weight:900;
    }

    .pill{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.04);
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:2px 4px 10px;
    }
    .title{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .count{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }

    /* --- 入力シート UI --- */
    .hint{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      margin:6px 4px 8px;
    }

    textarea{
      width:100%;
      min-height:120px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      font-size:16px;
      line-height:1.4;
      outline:none;
      background:#fff;
      resize:vertical;
    }
    textarea:focus{
      border-color:#bfd4ff;
      box-shadow:0 0 0 4px rgba(37,99,235,.08);
    }

    .miniBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:10px 0 2px;
    }
    .miniBtns .btn{
      border-radius:16px;
      padding:12px 14px;
    }
    .miniBtns .btn.secondary{
      background:#eef2ff;
    }

    /* --- 共通テーブル --- */
    .tableWrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    thead th{
      background:var(--head);
      color:#111827;
      font-size:13px;
      font-weight:900;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
    }

    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      vertical-align:middle;
      background:#fff;
    }
    tbody tr:last-child td{ border-bottom:none; }

    /* 列幅：#狭い、ID広い、PINそこそこ */
    .colNo{ width:52px; }
    .colId{ width:auto; }
    .colPin{ width:44%; max-width:360px; }

    /* #セル（背景ゴースト数字） */
    .noCell{
      position:relative;
      padding-left:12px;
      font-weight:900;
      color:#0f172a;
    }
    .noCell .noBadge{
      position:relative;
      z-index:2;
      display:inline-grid;
      place-items:center;
      width:28px;
      height:28px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid var(--line);
      font-weight:900;
    }
    .noCell::after{
      content:attr(data-ghost);
      position:absolute;
      left:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:34px;
      font-weight:1000;
      letter-spacing:-1px;
      opacity:var(--ghostOpacity);
      z-index:1;
      pointer-events:none;
      color:var(--ghostColor, #93c5fd);
      filter:saturate(120%);
    }

    /* 入力シートの編集セル */
    .editInput{
      width:100%;
      font-size:18px;
      font-weight:900;
      letter-spacing:.3px;
      border:1px solid transparent;
      background:transparent;
      outline:none;
      padding:10px 12px;
      border-radius:16px;
      min-height:44px;
    }
    .editInput:focus{
      border-color:#bfd4ff;
      background:#f8fbff;
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    /* コピーシートのセル（タップでコピー） */
    .tapCell{
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
      border:1px solid transparent;
      font-size:18px;
      font-weight:900;
      letter-spacing:.3px;
      user-select:text;
      cursor:pointer;
      touch-action:manipulation;
    }
    .tapCell:active{
      background:#f8fbff;
      border-color:#dbeafe;
    }

    /* コピー強調（薄い青） */
    .copied{
      background:var(--copiedBg) !important;
      border-color:var(--copiedBorder) !important;
      box-shadow:0 0 0 4px rgba(96,165,250,.20);
      transition:background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }

    /* 下タブ */
    .bottomTabs{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:10;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(160%) blur(10px);
      border-top:1px solid var(--line);
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{
      max-width:920px;
      margin:0 auto;
      display:flex;
      gap:12px;
    }
    .tabBtn{
      flex:1;
      border-radius:18px;
      padding:16px 14px;
      font-size:18px;
      font-weight:1000;
      border:1px solid var(--line);
      background:#fff;
      color:#0f172a;
      box-shadow:0 6px 18px rgba(15,23,42,.04);
    }
    .tabBtn.active{
      background:var(--btn);
      color:var(--btnText);
      border-color:transparent;
      box-shadow:0 10px 25px rgba(0,0,0,.10);
    }

    /* 画面切替 */
    .view{ display:none; }
    .view.active{ display:block; }

    /* 小画面最適化 */
    @media (max-width:480px){
      .wrap{ padding:12px 12px 92px; }
      .colPin{ width:46%; }
      .tapCell{ font-size:17px; }
      .editInput{ font-size:17px; }
    }

    /* iOSの「速い反応」寄り */
    .fastTap{ touch-action:manipulation; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="leftBtns">
          <button class="btn fastTap" id="btnSave">保存</button>
          <button class="btn secondary fastTap" id="btnLoad">読込</button>
          <button class="btn danger fastTap" id="btnClear">全削除</button>
        </div>

        <div class="rightBtns">
          <button class="btn icon secondary fastTap" id="btnUndo" title="戻る">←</button>
          <button class="btn icon secondary fastTap" id="btnRedo" title="進む">→</button>
          <span class="pill" id="statusPill">保存：未</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- 入力シート -->
    <section class="view active" id="viewInput">
      <div class="card">
        <div class="titleRow">
          <div class="title">入力</div>
          <div class="count">件数：<span id="countInput">0</span></div>
        </div>

        <div class="hint">
          ここに「ID PIN」を複数行で貼り付け → 「貼り付け反映」<br>
          （Excel/スプレッドシートからそのままコピペOK）
        </div>

        <textarea id="bulkArea" placeholder="例）VMA1069413711  8p7s@3WD&#10;VMA1070117886  t7Sgn?i2"></textarea>

        <div class="miniBtns">
          <button class="btn fastTap" id="btnApply">貼り付け反映</button>
          <button class="btn secondary fastTap" id="btnCopyTSV">データをコピー（TSV）</button>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:14px;">
        <div class="titleRow" style="padding:10px 12px;">
          <div class="title" style="font-size:16px;">ID / PIN</div>
          <div class="count">件数：<span id="countTable">0</span></div>
        </div>

        <table>
          <thead>
            <tr>
              <th class="colNo">#</th>
              <th class="colId">ID</th>
              <th class="colPin">PIN</th>
            </tr>
          </thead>
          <tbody id="tbodyEdit"></tbody>
        </table>
      </div>
    </section>

    <!-- コピーシート -->
    <section class="view" id="viewCopy">
      <div class="card">
        <div class="titleRow">
          <div class="title">ID / PIN</div>
          <div class="count">件数：<span id="countCopy">0</span></div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:14px;">
        <table>
          <thead>
            <tr>
              <th class="colNo">#</th>
              <th class="colId">ID</th>
              <th class="colPin">PIN</th>
            </tr>
          </thead>
          <tbody id="tbodyCopy"></tbody>
        </table>
      </div>

      <div style="height:18px;"></div>
    </section>
  </div>

  <!-- 下タブ -->
  <div class="bottomTabs">
    <div class="tabsInner">
      <button class="tabBtn active fastTap" id="tabInput">入力</button>
      <button class="tabBtn fastTap" id="tabCopy">コピー</button>
    </div>
  </div>

  <script>
    /**********************************************************
     * 仕様まとめ（ここ重要）
     * - 機能削除なし：保存/読込/全削除、Undo/Redo、貼り付け反映、TSVコピー、2シートUI
     * - コピーシート：コピーボタン無し。セルを押したらコピー。薄い青で強調。
     * - 入力シート：編集は1タップで全選択（iOS対策：pointerdown + focus + setSelectionRange）
     * - #列ギミック：背景に大きい数字（編集回数）。初期0。IDが「実際に変化」した時だけ+1。
     * - 背景数字は少し濃く（--ghostOpacity）。
     **********************************************************/

    const LS_KEY = "idpin_app_state_v6";

    // state
    let state = {
      rows: [], // {id:"", pin:"", ghost:0, lastIdForCount:""}
      bulkText: "",
      lastSavedAt: null,
    };

    // history for undo/redo
    let history = [];
    let historyIndex = -1;
    let pendingCommit = null;

    // DOM
    const statusPill = document.getElementById("statusPill");

    const btnSave = document.getElementById("btnSave");
    const btnLoad = document.getElementById("btnLoad");
    const btnClear = document.getElementById("btnClear");
    const btnUndo = document.getElementById("btnUndo");
    const btnRedo = document.getElementById("btnRedo");

    const tabInput = document.getElementById("tabInput");
    const tabCopy = document.getElementById("tabCopy");
    const viewInput = document.getElementById("viewInput");
    const viewCopy = document.getElementById("viewCopy");

    const bulkArea = document.getElementById("bulkArea");
    const btnApply = document.getElementById("btnApply");
    const btnCopyTSV = document.getElementById("btnCopyTSV");

    const tbodyEdit = document.getElementById("tbodyEdit");
    const tbodyCopy = document.getElementById("tbodyCopy");

    const countInput = document.getElementById("countInput");
    const countTable = document.getElementById("countTable");
    const countCopy = document.getElementById("countCopy");

    // util
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    function nowStr(){
      const d = new Date();
      const z = (n)=> String(n).padStart(2,"0");
      return `${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }

    function setStatus(text){
      statusPill.textContent = text;
    }

    function vibrate(ms=25){
      try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(_){}
    }

    function hslFromCount(n){
      // 0.. で色が変わる（目に優しめ、でも分かる）
      // 12色循環。濃さは控えめ。
      const hue = (n * 37) % 360;
      const sat = 78;
      const light = 62;
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    function safeRows(){
      if (!Array.isArray(state.rows)) state.rows = [];
      state.rows.forEach(r=>{
        if (typeof r.ghost !== "number") r.ghost = 0;
        if (typeof r.lastIdForCount !== "string") r.lastIdForCount = (r.id ?? "");
        if (typeof r.id !== "string") r.id = "";
        if (typeof r.pin !== "string") r.pin = "";
      });
    }

    function pushHistory(reason=""){
      // 連打で重くならないように、短時間の連続コミットはまとめる
      if (pendingCommit) clearTimeout(pendingCommit);
      pendingCommit = setTimeout(()=>{
        pendingCommit = null;

        const snap = deepClone(state);
        // redo側を切る
        history = history.slice(0, historyIndex + 1);
        history.push(snap);
        historyIndex = history.length - 1;

        updateUndoRedoButtons();
        if (reason) setStatus(`編集：${reason}`);
        else setStatus("編集：未保存");
      }, 120);
    }

    function updateUndoRedoButtons(){
      btnUndo.disabled = historyIndex <= 0;
      btnRedo.disabled = historyIndex >= history.length - 1;
      btnUndo.style.opacity = btnUndo.disabled ? 0.45 : 1;
      btnRedo.style.opacity = btnRedo.disabled ? 0.45 : 1;
    }

    function applySnapshot(snap){
      state = deepClone(snap);
      safeRows();
      bulkArea.value = state.bulkText || "";
      renderAll();
    }

    function undo(){
      if (historyIndex <= 0) return;
      historyIndex--;
      applySnapshot(history[historyIndex]);
      setStatus("戻る");
      updateUndoRedoButtons();
    }

    function redo(){
      if (historyIndex >= history.length - 1) return;
      historyIndex++;
      applySnapshot(history[historyIndex]);
      setStatus("進む");
      updateUndoRedoButtons();
    }

    // parsing bulk text
    function parseBulk(text){
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];
      for (const line of lines){
        // タブ/スペース区切り。最初の塊がID、残りをPINとして連結（PINにスペースがあっても崩れにくい）
        const parts = line.split(/\s+/).filter(Boolean);
        if (parts.length === 0) continue;
        const id = parts[0] ?? "";
        const pin = parts.slice(1).join("") ?? "";
        out.push({id, pin});
      }
      return out;
    }

    function buildTSV(){
      // ID \t PIN のTSV（行）
      return state.rows.map(r => `${r.id}\t${r.pin}`).join("\n");
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // fallback（iOS古い系）
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position="fixed";
          ta.style.left="-9999px";
          ta.style.top="-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        }catch(_){
          return false;
        }
      }
    }

    function flashCell(el){
      el.classList.add("copied");
      setTimeout(()=> el.classList.remove("copied"), 420);
    }

    function renderAll(){
      renderEditTable();
      renderCopyTable();
      updateCounts();
    }

    function updateCounts(){
      const n = state.rows.length;
      countInput.textContent = n;
      countTable.textContent = n;
      countCopy.textContent = n;
    }

    // ----------- render: edit table (input view) -----------
    function renderEditTable(){
      tbodyEdit.innerHTML = "";
      safeRows();

      state.rows.forEach((row, idx)=>{
        const tr = document.createElement("tr");

        // # (with ghost)
        const tdNo = document.createElement("td");
        tdNo.className = "noCell colNo";
        tdNo.setAttribute("data-ghost", String(row.ghost ?? 0));
        tdNo.style.setProperty("--ghostColor", hslFromCount(row.ghost ?? 0));

        const badge = document.createElement("span");
        badge.className = "noBadge";
        badge.textContent = String(idx + 1);
        tdNo.appendChild(badge);

        // ID input
        const tdId = document.createElement("td");
        tdId.className = "colId";

        const idInput = document.createElement("input");
        idInput.className = "editInput fastTap";
        idInput.type = "text";
        idInput.value = row.id;
        idInput.inputMode = "text";
        idInput.autocomplete = "off";
        idInput.spellcheck = false;

        // ★ 1タップで全選択（iOS対策）
        // pointerdown → focus前に selectAll を予約
        idInput.addEventListener("pointerdown", ()=>{
          // iOSは focus後に setSelectionRange しないと効きづらいので requestAnimationFrame 二段
          requestAnimationFrame(()=>{
            try{
              idInput.focus({preventScroll:true});
              requestAnimationFrame(()=>{
                idInput.setSelectionRange(0, idInput.value.length);
              });
            }catch(_){}
          });
        }, {passive:true});

        idInput.addEventListener("focus", ()=>{
          // さらに保険（初回タップで確実に）
          requestAnimationFrame(()=>{
            try{ idInput.setSelectionRange(0, idInput.value.length); }catch(_){}
          });
        });

        // ID変更：実際に値が変わった時だけ ghost++（同値なら増えない）
        idInput.addEventListener("input", ()=>{
          const newVal = idInput.value;

          // 反応良く：即 state へ反映（描画は最小限）
          const r = state.rows[idx];
          r.id = newVal;

          // ここは「変化の確定」を blur 時にしたいが、
          // ユーザー要望：編集したら増える。ただし同値は増えない。
          // → "前回確定値(lastIdForCount)" と違う値になった瞬間に +1 して lastIdForCount を更新
          if (newVal !== r.lastIdForCount){
            r.ghost = (r.ghost ?? 0) + 1;
            r.lastIdForCount = newVal;

            // #セルの表示だけ即更新（軽い）
            tdNo.setAttribute("data-ghost", String(r.ghost));
            tdNo.style.setProperty("--ghostColor", hslFromCount(r.ghost));
          }

          pushHistory("編集");
        });

        idInput.addEventListener("change", ()=>{
          // changeも保険
          pushHistory("編集");
        });

        tdId.appendChild(idInput);

        // PIN input
        const tdPin = document.createElement("td");
        tdPin.className = "colPin";

        const pinInput = document.createElement("input");
        pinInput.className = "editInput fastTap";
        pinInput.type = "text";
        pinInput.value = row.pin;
        pinInput.inputMode = "text";
        pinInput.autocomplete = "off";
        pinInput.spellcheck = false;

        // ★ 1タップで全選択
        pinInput.addEventListener("pointerdown", ()=>{
          requestAnimationFrame(()=>{
            try{
              pinInput.focus({preventScroll:true});
              requestAnimationFrame(()=>{
                pinInput.setSelectionRange(0, pinInput.value.length);
              });
            }catch(_){}
          });
        }, {passive:true});

        pinInput.addEventListener("focus", ()=>{
          requestAnimationFrame(()=>{
            try{ pinInput.setSelectionRange(0, pinInput.value.length); }catch(_){}
          });
        });

        pinInput.addEventListener("input", ()=>{
          state.rows[idx].pin = pinInput.value;
          pushHistory("編集");
        });

        tdPin.appendChild(pinInput);

        tr.appendChild(tdNo);
        tr.appendChild(tdId);
        tr.appendChild(tdPin);
        tbodyEdit.appendChild(tr);
      });
    }

    // ----------- render: copy table (copy view) -----------
    function renderCopyTable(){
      tbodyCopy.innerHTML = "";
      safeRows();

      state.rows.forEach((row, idx)=>{
        const tr = document.createElement("tr");

        // # (with ghost)
        const tdNo = document.createElement("td");
        tdNo.className = "noCell colNo";
        tdNo.setAttribute("data-ghost", String(row.ghost ?? 0));
        tdNo.style.setProperty("--ghostColor", hslFromCount(row.ghost ?? 0));

        const badge = document.createElement("span");
        badge.className = "noBadge";
        badge.textContent = String(idx + 1);
        tdNo.appendChild(badge);

        // ID tap-to-copy
        const tdId = document.createElement("td");
        tdId.className = "colId";

        const idCell = document.createElement("div");
        idCell.className = "tapCell fastTap";
        idCell.textContent = row.id || "";
        idCell.title = "タップでコピー";

        idCell.addEventListener("pointerdown", async (ev)=>{
          ev.preventDefault(); // 余計な選択/遅延を減らす
          const ok = await copyText(row.id || "");
          if (ok){
            flashCell(idCell);
            vibrate(22);
            setStatus(`コピー：ID（${nowStr()}）`);
          }else{
            setStatus("コピー失敗（クリップボード権限）");
          }
        });

        tdId.appendChild(idCell);

        // PIN tap-to-copy
        const tdPin = document.createElement("td");
        tdPin.className = "colPin";

        const pinCell = document.createElement("div");
        pinCell.className = "tapCell fastTap";
        pinCell.textContent = row.pin || "";
        pinCell.title = "タップでコピー";

        pinCell.addEventListener("pointerdown", async (ev)=>{
          ev.preventDefault();
          const ok = await copyText(row.pin || "");
          if (ok){
            flashCell(pinCell);
            vibrate(22);
            setStatus(`コピー：PIN（${nowStr()}）`);
          }else{
            setStatus("コピー失敗（クリップボード権限）");
          }
        });

        tdPin.appendChild(pinCell);

        tr.appendChild(tdNo);
        tr.appendChild(tdId);
        tr.appendChild(tdPin);
        tbodyCopy.appendChild(tr);
      });
    }

    // ---------- actions ----------
    function applyBulk(){
      const text = bulkArea.value || "";
      const parsed = parseBulk(text);

      // rowsを置き換え（ghostは新規は0、lastIdForCountは初期ID）
      state.rows = parsed.map(p => ({
        id: p.id,
        pin: p.pin,
        ghost: 0,
        lastIdForCount: p.id
      }));

      state.bulkText = text;
      pushHistory("貼り付け反映");
      renderAll();
    }

    async function copyTSV(){
      const tsv = buildTSV();
      const ok = await copyText(tsv);
      if (ok){
        setStatus(`コピー：TSV（${nowStr()}）`);
        vibrate(30);
      }else{
        setStatus("TSVコピー失敗（権限）");
      }
    }

    function save(){
      try{
        state.bulkText = bulkArea.value || "";
        const payload = deepClone(state);
        payload.lastSavedAt = Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
        setStatus(`保存：OK（${nowStr()}）`);
        vibrate(18);
      }catch(e){
        setStatus("保存失敗（容量/設定）");
      }
    }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw){
          setStatus("読込：データなし");
          return;
        }
        const loaded = JSON.parse(raw);
        state = loaded;
        safeRows();
        bulkArea.value = state.bulkText || "";
        pushHistory("読込");
        renderAll();
        setStatus(`読込：OK（${nowStr()}）`);
        vibrate(18);
      }catch(e){
        setStatus("読込失敗（破損）");
      }
    }

    function clearAll(){
      if (!confirm("全部消します。よろしいですか？")) return;
      state.rows = [];
      state.bulkText = "";
      bulkArea.value = "";
      pushHistory("全削除");
      renderAll();
      setStatus("全削除：OK");
      vibrate(25);
    }

    // view switch
    function showInput(){
      viewInput.classList.add("active");
      viewCopy.classList.remove("active");
      tabInput.classList.add("active");
      tabCopy.classList.remove("active");
      setStatus("入力");
    }
    function showCopy(){
      viewCopy.classList.add("active");
      viewInput.classList.remove("active");
      tabCopy.classList.add("active");
      tabInput.classList.remove("active");
      setStatus("コピー：セルを押すだけ");
    }

    // wire
    btnApply.addEventListener("click", applyBulk);
    btnCopyTSV.addEventListener("click", copyTSV);

    btnSave.addEventListener("click", save);
    btnLoad.addEventListener("click", load);
    btnClear.addEventListener("click", clearAll);

    btnUndo.addEventListener("click", undo);
    btnRedo.addEventListener("click", redo);

    tabInput.addEventListener("click", showInput);
    tabCopy.addEventListener("click", showCopy);

    // keyboard shortcuts (PC)
    window.addEventListener("keydown", (e)=>{
      const isMac = /Mac/.test(navigator.platform);
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (!mod) return;
      if (e.key.toLowerCase()==="z" && !e.shiftKey){
        e.preventDefault(); undo();
      }else if ((e.key.toLowerCase()==="z" && e.shiftKey) || e.key.toLowerCase()==="y"){
        e.preventDefault(); redo();
      }else if (e.key.toLowerCase()==="s"){
        e.preventDefault(); save();
      }
    });

    // init
    (function init(){
      safeRows();
      bulkArea.value = state.bulkText || "";

      // 初期ヒストリー
      history = [deepClone(state)];
      historyIndex = 0;
      updateUndoRedoButtons();

      renderAll();
      setStatus("起動");
    })();
  </script>
</body>
</html>
