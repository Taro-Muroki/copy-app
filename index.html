<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ID / PIN</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --head:#eef2ff;

      /* åå¿œï¼ˆã‚³ãƒ”ãƒ¼/ç·¨é›†ï¼‰ */
      --flash-bg:#0b1220;
      --flash-text:#ffffff;
      --flash-outline:rgba(11,18,32,.25);

      /* èƒŒæ™¯æ•°å­—ï¼ˆæ¿ƒãã—ãŸï¼‰ */
      --ghost-base: rgba(15,23,42,.18); /* â†ã“ã“ãŒæ¿ƒã•ã€‚ã‚‚ã£ã¨æ¿ƒãã—ãŸã„ãªã‚‰ .22 ã¨ã‹ã« */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
      overscroll-behavior-y: contain;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .app{
      max-width: 920px;
      margin: 0 auto;
      padding: 14px 12px calc(96px + env(safe-area-inset-bottom));
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    button{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:700;
      font-size:15px;
      line-height:1;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{
      background:#0b1220;
      border-color:#0b1220;
      color:#fff;
    }
    button.danger{
      background:#ffe9ea;
      border-color:#ffd0d3;
      color:#a11b1b;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; }

    .navbtn{
      width:44px;
      height:44px;
      display:grid;
      place-items:center;
      border-radius:14px;
      font-size:18px;
      font-weight:900;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 3px 18px rgba(15,23,42,.05);
      margin-bottom:12px;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆæ³¨æ„æ›¸ãã¯æ¥µåŠ›å‰Šã£ãŸï¼‰ */
    .inputHead{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px 2px;
      display:none; /* â†ã€Œæ³¨æ„æ›¸ããªãã—ã¦ã€ãªã®ã§éè¡¨ç¤ºã€‚å¿…è¦ãªã‚‰ true ã«ã—ã¦è¡¨ç¤ºã—ã¦ã‚‚OK */
    }

    textarea{
      width:100%;
      min-height:104px;
      max-height:180px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      font-size:16px;
      line-height:1.35;
      outline:none;
      background:#fbfcff;
      -webkit-overflow-scrolling: touch;
    }

    .midBtns{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .midBtns button{
      flex:1 1 180px;
      justify-content:center;
      padding:12px 14px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ï¼‰ */
    .tableWrap{
      overflow:hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed; /* â†åˆ—å¹…å›ºå®šã§æ¨ªã¶ã‚Œ/æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
      font-size:16px;
    }

    thead th{
      background: #f0f2f6;
      color: #111827;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      letter-spacing:.02em;
    }

    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      position:relative;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    tbody tr:last-child td{ border-bottom:none; }

    /* åˆ—å¹…ï¼š#ã¯ç‹­ãã€IDåºƒãã€PINã¯ãã“ãã“ */
    col.colN { width: 56px; }      /* # */
    col.colID{ width: auto; }      /* ID */
    col.colPIN{ width: 40%; }      /* PIN */
    col.colBtn{ width: 54px; }     /* ã‚³ãƒ”ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */

    /* #åˆ—ï¼šèƒŒæ™¯æ•°å­—ï¼ˆã‚´ãƒ¼ã‚¹ãƒˆï¼‰ */
    .ncell{
      text-align:center;
      font-weight:900;
    }
    .ghost{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
      font-weight:900;
      font-size:28px;
      letter-spacing:-.04em;
      opacity:1;
      color: var(--ghost-base);
      transform: translateY(1px);
    }
    .nnum{
      position:relative;
      z-index:1;
      display:inline-grid;
      place-items:center;
      width:30px;
      height:30px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid rgba(59,130,246,.20);
      font-size:14px;
    }

    /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆID/PINï¼‰ */
    .cellInput{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      font-size:18px;
      font-weight:800;
      padding:8px 10px;
      border-radius:14px;
      outline:none;
      min-height:40px;
    }
    .cellInput:focus{
      border-color: rgba(59,130,246,.25);
      background:#f8fbff;
      box-shadow: 0 0 0 3px rgba(59,130,246,.10);
    }

    /* ã‚³ãƒ”ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
    .copyBtn{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(59,130,246,.20);
      background:#eef2ff;
      display:grid;
      place-items:center;
      font-size:18px;
      font-weight:900;
      user-select:none;
    }
    .copyBtn:active{ transform: translateY(1px); }

    /* ã‚³ãƒ”ãƒ¼/ç·¨é›†ã®å¼·ã„åå¿œï¼ˆå˜ç‹¬ã‚»ãƒ«ã ã‘å…‰ã‚‹ï¼‰ */
    .flash{
      background: var(--flash-bg) !important;
      color: var(--flash-text) !important;
      outline: 3px solid var(--flash-outline);
      transition: background .12s ease, color .12s ease, outline .12s ease;
    }
    .flashInput{
      background: var(--flash-bg) !important;
      color: var(--flash-text) !important;
      border-color: var(--flash-bg) !important;
    }

    /* ä¸‹ã®å›ºå®šãƒãƒ¼ï¼ˆå…¥åŠ› / ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼‰ */
    .bottomBar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(244,246,251,.85);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(229,231,235,.8);
    }
    .bottomInner{
      max-width: 920px;
      margin:0 auto;
      display:flex;
      gap:12px;
    }
    .tabBtn{
      flex:1 1 0;
      padding:16px 14px;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
    }
    .tabBtn.active{
      background:#0b1220;
      border-color:#0b1220;
      color:#fff;
    }

    /* ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */
    .modeLabel{
      font-size:12px;
      color:var(--muted);
      margin: 0 0 10px 2px;
    }

    /* å°ç”»é¢æœ€é©åŒ– */
    @media (max-width:420px){
      col.colPIN{ width: 44%; }
      .cellInput{ font-size:17px; }
      .ghost{ font-size:26px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="btnrow">
        <button class="primary" id="btnSave">ä¿å­˜</button>
        <button id="btnLoad">èª­è¾¼</button>
        <button class="danger" id="btnClearAll">å…¨å‰Šé™¤</button>
      </div>

      <div class="btnrow">
        <button class="navbtn" id="btnUndo" title="æˆ»ã‚‹">â†</button>
        <button class="navbtn" id="btnRedo" title="é€²ã‚€">â†’</button>
      </div>
    </div>

    <div class="card" id="inputCard">
      <div class="modeLabel">å…¥åŠ›ï¼ˆè²¼ã‚Šä»˜ã‘ â†’ åæ˜ ï¼‰</div>
      <p class="hint">ã“ã“ã«ã€ŒID PINã€ã‚’è¤‡æ•°è¡Œã§è²¼ã‚Šä»˜ã‘ â†’ åæ˜ </p>
      <textarea id="bulkText" placeholder="ä¾‹ï¼šVMA1069413711  8p7s@3WD"></textarea>

      <div class="midBtns">
        <button class="primary" id="btnApply">è²¼ã‚Šä»˜ã‘åæ˜ </button>
        <button id="btnCopyTSV">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆTSVï¼‰</button>
      </div>
    </div>

    <div class="tableWrap" id="tableWrap">
      <table>
        <colgroup>
          <col class="colN">
          <col class="colID">
          <col class="colBtn">
          <col class="colPIN">
          <col class="colBtn">
        </colgroup>
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th></th>
            <th>PIN</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <button class="tabBtn active" id="tabInput">å…¥åŠ›</button>
      <button class="tabBtn" id="tabCopy">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

<script>
(() => {
  // ====== çŠ¶æ…‹ ======
  const LS_KEY = "idpin_rows_v2";
  const LS_GHOST = "idpin_ghost_v2";

  /** rows: [{id:"", pin:""}] */
  let rows = [];

  /** ghostCount: è¡Œã”ã¨ã®ç·¨é›†ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆèƒŒæ™¯ã®è–„æ•°å­—ï¼‰ */
  let ghostCount = [];

  // Undo/Redoï¼ˆè»½é‡ï¼‰
  const history = [];
  let histPos = -1;
  const MAX_HISTORY = 60;

  // ç·¨é›†æ™‚ã®ã€ŒåŒå€¤ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ã€åˆ¤å®šã®ãŸã‚ã«ä¿æŒ
  const lastValue = new Map(); // key: "r{idx}:id" / "r{idx}:pin" -> string

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const bulkText = $("bulkText");

  const btnSave = $("btnSave");
  const btnLoad = $("btnLoad");
  const btnClearAll = $("btnClearAll");
  const btnApply = $("btnApply");
  const btnCopyTSV = $("btnCopyTSV");
  const btnUndo = $("btnUndo");
  const btnRedo = $("btnRedo");

  const tabInput = $("tabInput");
  const tabCopy = $("tabCopy");
  const inputCard = $("inputCard");

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function pushHistory() {
    const snap = {
      rows: deepClone(rows),
      ghost: deepClone(ghostCount),
    };
    // histPos ä»¥é™ã‚’åˆ‡ã‚Šæ¨ã¦
    history.splice(histPos + 1);
    history.push(snap);
    if (history.length > MAX_HISTORY) history.shift();
    histPos = history.length - 1;
    updateUndoRedo();
  }

  function applyHistory(pos){
    if (pos < 0 || pos >= history.length) return;
    histPos = pos;
    rows = deepClone(history[histPos].rows);
    ghostCount = deepClone(history[histPos].ghost);
    render();
    updateUndoRedo();
  }

  function updateUndoRedo(){
    btnUndo.disabled = !(histPos > 0);
    btnRedo.disabled = !(histPos < history.length - 1);
  }

  // èƒŒæ™¯æ•°å­—ã®è‰²ã‚’ã€Œæ•°å­—ã«ã‚ˆã£ã¦å¤‰ãˆã‚‹ã€
  function ghostColor(n){
    // n ã‚’æ®µéšåŒ–
    // 0: é’ç³»è–„ / 1-3: ç´« / 4-9: ç·‘ / 10-19: æ©™ / 20+: èµ¤
    let hue = 220, sat = 80, light = 40, alpha = 0.22; // â†æ¿ƒã•ã¯ã“ã“
    if (n === 0) { hue = 220; alpha = 0.20; }
    else if (n <= 3) { hue = 270; alpha = 0.22; }
    else if (n <= 9) { hue = 145; alpha = 0.22; }
    else if (n <= 19) { hue = 28;  alpha = 0.24; }
    else { hue = 0; alpha = 0.24; }
    return `hsla(${hue}, ${sat}%, ${light}%, ${alpha})`;
  }

  async function copyText(text){
    // iOS Safari/Chrome å¯¾å¿œã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ã
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(e2){
        return false;
      }
    }
  }

  function flashOne(el, cls="flash", ms=180){
    if (!el) return;
    el.classList.add(cls);
    // åå¿œã‚’é€Ÿãï¼ˆé€£æ‰“æ™‚ã‚‚æ½°ã‚Œãªã„ï¼‰
    setTimeout(() => el.classList.remove(cls), ms);
  }

  function ensureRows(n){
    while(rows.length < n) rows.push({id:"", pin:""});
    while(ghostCount.length < n) ghostCount.push(0);
  }

  function normalizeLine(line){
    // ã‚¿ãƒ–/è¤‡æ•°ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨±å®¹
    const s = line.trim();
    if(!s) return null;
    const parts = s.split(/\s+/);
    if(parts.length === 1){
      return { id: parts[0], pin: "" };
    }
    const id = parts[0];
    const pin = parts.slice(1).join(" ");
    return { id, pin };
  }

  function rowsToTSV(){
    // ID \t PIN \n
    return rows
      .filter(r => (r.id || r.pin))
      .map(r => `${r.id}\t${r.pin}`)
      .join("\n");
  }

  // ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆé«˜é€Ÿï¼štbodyã‚’ä¸€æ°—ã«å·®ã—æ›¿ãˆï¼‰ ======
  function render(){
    const frag = document.createDocumentFragment();

    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      const tr = document.createElement("tr");
      tr.dataset.row = String(i);

      // #ã‚»ãƒ«ï¼ˆèƒŒæ™¯ã‚´ãƒ¼ã‚¹ãƒˆï¼‰
      const tdN = document.createElement("td");
      tdN.className = "ncell";
      tdN.innerHTML = `
        <div class="ghost" style="color:${ghostColor(ghostCount[i]||0)}">${ghostCount[i]||0}</div>
        <span class="nnum">${i+1}</span>
      `;

      // IDå…¥åŠ›
      const tdID = document.createElement("td");
      tdID.innerHTML = `<input class="cellInput" inputmode="text" autocomplete="off" spellcheck="false"
        data-field="id" value="${escapeHtml(r.id)}" />`;

      // ID ã‚³ãƒ”ãƒ¼
      const tdIDC = document.createElement("td");
      tdIDC.innerHTML = `<div class="copyBtn" role="button" aria-label="copy id" data-copy="id">ğŸ“‹</div>`;

      // PINå…¥åŠ›
      const tdPIN = document.createElement("td");
      tdPIN.innerHTML = `<input class="cellInput" inputmode="text" autocomplete="off" spellcheck="false"
        data-field="pin" value="${escapeHtml(r.pin)}" />`;

      // PIN ã‚³ãƒ”ãƒ¼
      const tdPINC = document.createElement("td");
      tdPINC.innerHTML = `<div class="copyBtn" role="button" aria-label="copy pin" data-copy="pin">ğŸ“‹</div>`;

      tr.appendChild(tdN);
      tr.appendChild(tdID);
      tr.appendChild(tdIDC);
      tr.appendChild(tdPIN);
      tr.appendChild(tdPINC);

      frag.appendChild(tr);
    }

    // å·®ã—æ›¿ãˆ
    tbody.replaceChildren(frag);

    // lastValue ã‚’æ›´æ–°ï¼ˆåŒå€¤åˆ¤å®šç”¨ï¼‰
    for(let i=0;i<rows.length;i++){
      lastValue.set(`r${i}:id`, rows[i].id || "");
      lastValue.set(`r${i}:pin`, rows[i].pin || "");
    }
  }

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ====== ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯å§”è­²ã§è»½ãï¼‰ ======

  // 1) ã‚³ãƒ”ãƒ¼ï¼ˆå˜ç‹¬ã‚»ãƒ«ã ã‘åå¿œï¼‰
  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-copy]");
    if(!btn) return;

    const tr = btn.closest("tr");
    if(!tr) return;

    const idx = Number(tr.dataset.row);
    const which = btn.dataset.copy; // "id" or "pin"
    const value = (rows[idx] && rows[idx][which]) ? rows[idx][which] : "";

    const ok = await copyText(value);

    // åå¿œã‚’å¼·ãï¼šãƒœã‚¿ãƒ³ã¨å¯¾è±¡inputã ã‘å…‰ã‚‰ã›ã‚‹
    flashOne(btn, "flash", 220);
    const input = tr.querySelector(`input[data-field="${which}"]`);
    if (input) flashOne(input, "flashInput", 220);

    // ã‚³ãƒ”ãƒ¼å¤±æ•—ãªã‚‰å°‘ã—é•·ã‚ã«å…‰ã‚‰ã›ã‚‹ï¼ˆæ°—ã¥ã‘ã‚‹ï¼‰
    if(!ok){
      flashOne(btn, "flash", 420);
    }
  });

  // 2) ç·¨é›†ï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å…¨é¸æŠï¼ˆã‚ãªãŸã®è¦æœ›ï¼‰
  tbody.addEventListener("focusin", (e) => {
    const input = e.target.closest("input[data-field]");
    if(!input) return;
    // iOSã§ç¢ºå®Ÿã«å…¨é¸æŠã•ã‚Œã‚‹ã‚ˆã†ã«é…å»¶
    requestAnimationFrame(() => {
      try{ input.select(); }catch(_){}
    });
  });

  // 3) ç·¨é›†ï¼šå€¤åæ˜ ï¼ˆIDã‚’ç·¨é›†ã—ãŸæ™‚ã ã‘ ghostCount++ã€åŒå€¤ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  let editTimer = null;
  tbody.addEventListener("input", (e) => {
    const input = e.target.closest("input[data-field]");
    if(!input) return;

    const tr = input.closest("tr");
    const idx = Number(tr.dataset.row);
    const field = input.dataset.field; // id / pin
    const newVal = input.value ?? "";

    // rowsã«å³åæ˜ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹å„ªå…ˆï¼‰
    rows[idx][field] = newVal;

    // ghostCount ãƒ«ãƒ¼ãƒ«ï¼šIDç·¨é›†ã ã‘ã€ã‹ã¤ã€Œå‰ã¨åŒã˜å€¤ã€ãªã‚‰å¢—ã‚„ã•ãªã„
    if(field === "id"){
      const key = `r${idx}:id`;
      const prev = lastValue.get(key) ?? "";
      if(newVal !== prev){
        ghostCount[idx] = (ghostCount[idx] || 0) + 1;
        // ã‚´ãƒ¼ã‚¹ãƒˆã ã‘æ›´æ–°ï¼ˆrenderå…¨ä½“ã¯é‡ã„ã®ã§éƒ¨åˆ†æ›´æ–°ï¼‰
        const ghost = tr.querySelector(".ghost");
        if(ghost){
          ghost.textContent = String(ghostCount[idx]);
          ghost.style.color = ghostColor(ghostCount[idx]);
        }
        lastValue.set(key, newVal);
      }
    }else{
      lastValue.set(`r${idx}:pin`, newVal);
    }

    // Undo/Redo ã®ãŸã‚ã€ç·¨é›†ã‚’ã¾ã¨ã‚ã¦å±¥æ­´ã«å…¥ã‚Œã‚‹ï¼ˆé€£æ‰“ã§ã‚‚è»½ã„ï¼‰
    clearTimeout(editTimer);
    editTimer = setTimeout(() => {
      pushHistory();
    }, 250);
  });

  // ====== ä¸Šéƒ¨ãƒœã‚¿ãƒ³ç¾¤ ======
  btnSave.addEventListener("click", () => {
    localStorage.setItem(LS_KEY, JSON.stringify(rows));
    localStorage.setItem(LS_GHOST, JSON.stringify(ghostCount));
    flashOne(btnSave, "flash", 220);
  });

  btnLoad.addEventListener("click", () => {
    const r = localStorage.getItem(LS_KEY);
    const g = localStorage.getItem(LS_GHOST);
    try{
      rows = r ? JSON.parse(r) : [];
      ghostCount = g ? JSON.parse(g) : [];
      if(!Array.isArray(rows)) rows = [];
      if(!Array.isArray(ghostCount)) ghostCount = [];
    }catch(e){
      rows = [];
      ghostCount = [];
    }
    if(rows.length === 0){
      ensureRows(30); // åˆæœŸ30è¡Œ
    }else{
      ensureRows(rows.length);
    }
    render();
    pushHistory();
    flashOne(btnLoad, "flash", 220);
  });

  btnClearAll.addEventListener("click", () => {
    if(!confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    rows = [];
    ghostCount = [];
    ensureRows(30);
    render();
    pushHistory();
    flashOne(btnClearAll, "flash", 220);
  });

  btnApply.addEventListener("click", () => {
    const lines = bulkText.value.split(/\r?\n/).map(normalizeLine).filter(Boolean);
    if(lines.length === 0) return;

    ensureRows(Math.max(30, lines.length));

    for(let i=0;i<lines.length;i++){
      rows[i].id = lines[i].id || "";
      rows[i].pin = lines[i].pin || "";
      // è²¼ã‚Šä»˜ã‘åæ˜ ã¯ã€Œç·¨é›†ã‚«ã‚¦ãƒ³ãƒˆã€ã«å…¥ã‚Œãªã„ï¼ˆè¦æœ›ãŒã‚ã‚Œã°ã“ã“ã§å¢—ã‚„ã™ã‚ˆã†ã«ã‚‚ã§ãã‚‹ï¼‰
    }

    render();
    pushHistory();
    flashOne(btnApply, "flash", 220);
  });

  btnCopyTSV.addEventListener("click", async () => {
    const tsv = rowsToTSV();
    const ok = await copyText(tsv);
    flashOne(btnCopyTSV, "flash", ok ? 220 : 420);
  });

  btnUndo.addEventListener("click", () => applyHistory(histPos - 1));
  btnRedo.addEventListener("click", () => applyHistory(histPos + 1));

  // ====== ä¸‹ã‚¿ãƒ–ï¼ˆå…¥åŠ›/ã‚³ãƒ”ãƒ¼ï¼‰ ======
  function setMode(mode){
    if(mode === "input"){
      tabInput.classList.add("active");
      tabCopy.classList.remove("active");
      inputCard.style.display = "";
      // å…¥åŠ›ã¸è¡Œã£ãŸã‚‰ textarea ã‚’å³ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã‚„ã™ãï¼ˆä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰
      // bulkText.focus();
    }else{
      tabCopy.classList.add("active");
      tabInput.classList.remove("active");
      inputCard.style.display = "none";
    }
  }
  tabInput.addEventListener("click", () => setMode("input"));
  tabCopy.addEventListener("click", () => setMode("copy"));

  // ====== åˆæœŸåŒ– ======
  function init(){
    // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãŒã‚ã‚Œã°èª­ã‚€
    const r = localStorage.getItem(LS_KEY);
    const g = localStorage.getItem(LS_GHOST);
    try{
      rows = r ? JSON.parse(r) : [];
      ghostCount = g ? JSON.parse(g) : [];
      if(!Array.isArray(rows)) rows = [];
      if(!Array.isArray(ghostCount)) ghostCount = [];
    }catch(e){
      rows = [];
      ghostCount = [];
    }

    if(rows.length === 0){
      ensureRows(30);
    }else{
      ensureRows(rows.length);
    }

    render();
    pushHistory(); // åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«
    setMode("input");
  }

  init();

})();
</script>
</body>
</html>
