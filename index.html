<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ID / PIN</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5eaf2;
      --head:#f1f5f9;

      --primary:#0b1220;
      --primaryText:#ffffff;

      --dangerBg:#fde2e2;
      --dangerText:#b42318;

      --chip:#eef2ff;
      --chipLine:#c7d2fe;

      --focus:#c7d2fe;

      /* コピー強調（薄い青） */
      --copiedBg:#dbeafe;
      --copiedLine:#93c5fd;

      /* #列 背景数字（見えるように） */
      --ghostAlpha:0.28; /* ← 0.22 → 少し濃く */
      --ghostSize:46px;  /* ← 大きくして見えやすく */

      /* テーブル列幅（#最狭 / ID最広 / PIN次） */
      --colNum:40px;
      --colId:2.2fr;
      --colPin:1.4fr;
      --colBtn:56px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      -webkit-font-smoothing:antialiased;
      overscroll-behavior-y:contain;
    }
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    /* ===== Top ===== */
    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      padding:10px 12px 6px; /* ← 少し詰める */
    }
    .toprow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btnrow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:700;
      letter-spacing:.01em;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:scale(.98);}
    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }
    .btn.danger{
      background:var(--dangerBg);
      color:var(--dangerText);
      border-color:transparent;
      font-weight:800;
    }
    .btn.icon{
      width:44px;height:44px;
      padding:0;
      display:grid;
      place-items:center;
      border-radius:14px;
      background:#eef2ff;
      border:1px solid #dbeafe;
      font-size:18px;
    }
    .btn:disabled{
      opacity:.45;
      filter:grayscale(.2);
      transform:none;
    }
    .titleline{
      margin-top:6px; /* ← 少し詰める */
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:18px;
      font-weight:900;
    }
    .count{
      font-size:14px;
      color:var(--muted);
      font-weight:800;
    }

    /* ===== Content ===== */
    .content{
      width:min(980px,100%);
      margin:0 auto;
      padding:8px 12px 88px; /* ← 上の余白を削る（無駄スペース対策） */
      display:flex;
      flex-direction:column;
      gap:10px; /* ← カード間を詰める */
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }

    /* 入力（貼り付け） */
    .pasteWrap{
      display:flex;
      flex-direction:column;
      gap:10px; /* ← 詰める */
    }
    .pasteLabel{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
    }
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px;
      font-size:18px;
      line-height:1.35;
      outline:none;
      background:#fbfdff;
      -webkit-overflow-scrolling:touch;
    }
    textarea:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.35);
    }
    .actions2{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .actions2 .btn{
      flex:1;
      min-width:160px;
      padding:14px 16px;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
    }

    /* テーブル */
    .tableCard{
      padding:0;
      overflow:hidden;
    }
    .thead{
      background:var(--head);
      border-bottom:1px solid var(--line);
    }
    .tr{
      display:grid;
      grid-template-columns: var(--colNum) var(--colId) var(--colBtn) var(--colPin) var(--colBtn);
      align-items:center;
      gap:0;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
    }
    .thead .tr{
      padding:10px 10px;
      font-weight:900;
      color:#334155;
      font-size:14px;
    }
    .tbody .tr{ background:var(--card); }
    .tbody .tr:last-child{border-bottom:none;}

    /* #列（バッジ + 背景ゴースト数字） */
    .numCell{
      position:relative;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:visible;
    }
    .numBadge{
      width:34px;height:34px;
      display:grid;
      place-items:center;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chipLine);
      font-weight:900;
      color:#0f172a;
      z-index:2;
    }
    .ghost{
      position:absolute;
      top:50%;
      left:2px; /* ← 少し左に寄せて、バッジに隠れないように */
      transform:translateY(-50%);
      font-weight:1000;
      font-size:var(--ghostSize);
      letter-spacing:-.04em;
      z-index:1;
      pointer-events:none;
      opacity:var(--ghostAlpha);
      filter:saturate(1.2);
      line-height:1;
      width:100%;
      text-align:left;
    }

    /* 値セル（入力/表示） */
    .valCell{
      padding:0 8px;
      min-width:0;
    }
    .field{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      padding:12px 10px;
      border-radius:14px;
      font-size:22px;
      font-weight:900;
      outline:none;
      min-width:0;
    }
    .field::placeholder{color:#cbd5e1;font-weight:800;}
    .field:focus{
      background:#f8fafc;
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.35);
    }

    /* 入力シート：コピーボタン（復活） */
    .copyBtn{
      width:52px;height:44px;
      margin:0 auto;
      border-radius:14px;
      border:1px solid #dbeafe;
      background:#eef2ff;
      display:grid;
      place-items:center;
      font-size:13px;
      font-weight:1000;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .15s ease;
    }
    .copyBtn:active{transform:scale(.98);}
    .copyBtn.disabled{
      opacity:.35;
      filter:grayscale(.3);
      pointer-events:none;
    }

    /* コピーシート：セルタップでコピー（ボタン無し） */
    .copyMode .tr{
      grid-template-columns: var(--colNum) var(--colId) var(--colPin);
    }
    .copyMode .copyTap{
      border-radius:14px;
      padding:12px 10px;
      font-size:22px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:background .12s ease, box-shadow .12s ease;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .copyMode .copyTap:active{ background:#eef2ff; }

    /* コピー強調（薄い青） */
    .copied{
      background:var(--copiedBg) !important;
      box-shadow:inset 0 0 0 2px var(--copiedLine);
    }

    /* 下ナビ */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px 18px;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(180%) blur(12px);
      border-top:1px solid var(--line);
      z-index:40;
    }
    .navInner{
      width:min(980px,100%);
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .navBtn{
      border-radius:22px;
      padding:16px 16px;
      font-size:20px;
      font-weight:1000;
      border:1px solid var(--line);
      background:var(--card);
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .navBtn.active{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }

    /* トースト */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:92px;
      background:#0b1220;
      color:white;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      z-index:60;
      max-width:min(92vw,520px);
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    @media (max-width:520px){
      :root{
        --colNum:38px;
        --colBtn:52px;
      }
      .field{font-size:20px;}
      .copyMode .copyTap{font-size:20px;}
      .copyBtn{width:48px;}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div class="btnrow">
        <button class="btn primary" id="btnSave">保存</button>
        <button class="btn" id="btnLoad">読込</button>
        <button class="btn danger" id="btnClear">全削除</button>
      </div>

      <div class="btnrow">
        <button class="btn icon" id="btnUndo" title="戻る" aria-label="戻る">←</button>
        <button class="btn icon" id="btnRedo" title="進む" aria-label="進む">→</button>
      </div>
    </div>

    <div class="titleline">
      <div class="title" id="screenTitle">入力</div>
      <div class="count" id="countLabel">件数：0</div>
    </div>
  </div>

  <div class="content" id="content"></div>

  <div class="nav">
    <div class="navInner">
      <div class="navBtn active" id="navInput">入力</div>
      <div class="navBtn" id="navCopy">コピー</div>
    </div>
  </div>

  <div class="toast" id="toast">コピーしました</div>
</div>

<script>
(() => {
  "use strict";

  const MAX_ROWS = 200;
  const LS_KEY_DATA = "idpin_data_v3";
  const LS_KEY_HIST = "idpin_hist_v3";

  const state = {
    screen: "input",
    rows: [],
    history: { undo: [], redo: [] },
    lastCopiedEl: null,
    lastCopiedTimer: null,
  };

  function makeEmptyRows(){
    const a = [];
    for(let i=0;i<MAX_ROWS;i++){
      a.push({ id:"", pin:"", editCount:0, lastCommittedId:"" });
    }
    return a;
  }

  const $ = (sel, root=document) => root.querySelector(sel);

  const content = $("#content");
  const screenTitle = $("#screenTitle");
  const countLabel = $("#countLabel");
  const toast = $("#toast");

  const btnSave = $("#btnSave");
  const btnLoad = $("#btnLoad");
  const btnClear = $("#btnClear");
  const btnUndo = $("#btnUndo");
  const btnRedo = $("#btnRedo");

  const navInput = $("#navInput");
  const navCopy  = $("#navCopy");

  function activeCount(){
    return state.rows.filter(r => (r.id || r.pin)).length;
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(state._toastTimer);
    state._toastTimer = setTimeout(() => toast.classList.remove("show"), 900);
  }

  async function copyText(text){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  function setCopiedHighlight(el){
    if(state.lastCopiedEl && state.lastCopiedEl !== el){
      state.lastCopiedEl.classList.remove("copied");
    }
    el.classList.add("copied");
    state.lastCopiedEl = el;

    clearTimeout(state.lastCopiedTimer);
    state.lastCopiedTimer = setTimeout(() => {
      if(state.lastCopiedEl){
        state.lastCopiedEl.classList.remove("copied");
        state.lastCopiedEl = null;
      }
    }, 700);
  }

  function ghostColor(editCount){
    const palette = ["#2563eb","#7c3aed","#db2777","#ea580c","#16a34a","#0891b2","#b45309","#334155"];
    return palette[Math.abs(editCount) % palette.length];
  }

  function deepCloneRows(rows){
    return rows.map(r => ({
      id: r.id,
      pin: r.pin,
      editCount: r.editCount,
      lastCommittedId: r.lastCommittedId
    }));
  }

  function pushHistory(reason){
    state.history.undo.push({ t: Date.now(), reason, rows: deepCloneRows(state.rows) });
    state.history.redo = [];
    syncUndoRedoButtons();
    saveHistoryToLS();
  }

  function applySnapshot(snapshot, from){
    state.rows = deepCloneRows(snapshot.rows);
    syncUndoRedoButtons();
    render();
    showToast(from === "undo" ? "戻しました" : "進めました");
  }

  function saveHistoryToLS(){
    try{
      const slim = { undo: state.history.undo.slice(-60), redo: state.history.redo.slice(-60) };
      localStorage.setItem(LS_KEY_HIST, JSON.stringify(slim));
    }catch(e){}
  }

  function loadHistoryFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_HIST);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && Array.isArray(obj.undo) && Array.isArray(obj.redo)){
        state.history.undo = obj.undo;
        state.history.redo = obj.redo;
      }
    }catch(e){}
  }

  function syncUndoRedoButtons(){
    btnUndo.disabled = state.history.undo.length === 0;
    btnRedo.disabled = state.history.redo.length === 0;
  }

  function saveToLS(){
    try{
      const payload = { v:3, savedAt: Date.now(), rows: deepCloneRows(state.rows) };
      localStorage.setItem(LS_KEY_DATA, JSON.stringify(payload));
      showToast("保存しました");
    }catch(e){
      showToast("保存に失敗");
    }
  }

  function loadFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if(!raw){ showToast("保存データなし"); return; }
      const payload = JSON.parse(raw);
      if(!payload || !Array.isArray(payload.rows)){ showToast("読込失敗"); return; }

      pushHistory("load");
      state.rows = makeEmptyRows();
      for(let i=0;i<Math.min(MAX_ROWS, payload.rows.length);i++){
        const r = payload.rows[i];
        state.rows[i].id = (r.id ?? "");
        state.rows[i].pin = (r.pin ?? "");
        state.rows[i].editCount = (r.editCount ?? 0);
        state.rows[i].lastCommittedId = (r.lastCommittedId ?? state.rows[i].id);
      }
      render();
      showToast("読込しました");
    }catch(e){
      showToast("読込に失敗");
    }
  }

  function clearAll(){
    pushHistory("clear");
    state.rows = makeEmptyRows();
    render();
    showToast("全削除しました");
  }

  function parsePasted(text){
    const lines = (text || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      const parts = line.split(/\s+/);
      const id = parts[0] ?? "";
      const pin = parts[1] ?? "";
      if(id || pin) out.push({id, pin});
    }
    return out;
  }

  function applyPasted(text){
    const parsed = parsePasted(text);
    pushHistory("apply_paste");

    state.rows = makeEmptyRows();
    for(let i=0;i<Math.min(MAX_ROWS, parsed.length);i++){
      state.rows[i].id = parsed[i].id;
      state.rows[i].pin = parsed[i].pin;
      state.rows[i].editCount = 0;
      state.rows[i].lastCommittedId = parsed[i].id;
    }
    render();
    showToast("貼り付け反映しました");
  }

  function buildTSV(){
    const rows = state.rows.filter(r => (r.id || r.pin));
    return rows.map(r => `${r.id}\t${r.pin}`).join("\n");
  }

  async function copyTSV(){
    const tsv = buildTSV();
    if(!tsv){ showToast("データなし"); return; }
    const ok = await copyText(tsv);
    showToast(ok ? "TSVをコピーしました" : "コピー失敗");
  }

  function commitIdEdit(rowIndex, newId){
    const r = state.rows[rowIndex];
    const prevCommitted = r.lastCommittedId ?? "";
    const next = newId ?? "";
    if(next !== prevCommitted){
      r.editCount = (r.editCount ?? 0) + 1;
      r.lastCommittedId = next;
    }
  }

  function attachSelectAllBehavior(inputEl){
    inputEl.addEventListener("pointerdown", () => { inputEl.dataset.sel = "1"; }, {passive:true});
    inputEl.addEventListener("focus", () => {
      if(inputEl.dataset.sel === "1"){
        requestAnimationFrame(() => {
          try{ inputEl.setSelectionRange(0, inputEl.value.length); }catch(e){}
          inputEl.dataset.sel = "0";
        });
      }
    });
  }

  function undo(){
    if(state.history.undo.length === 0) return;
    const snap = state.history.undo.pop();
    state.history.redo.push({ t: Date.now(), reason:"redo_from_undo", rows: deepCloneRows(state.rows) });
    saveHistoryToLS();
    applySnapshot(snap, "undo");
  }

  function redo(){
    if(state.history.redo.length === 0) return;
    const snap = state.history.redo.pop();
    state.history.undo.push({ t: Date.now(), reason:"undo_from_redo", rows: deepCloneRows(state.rows) });
    saveHistoryToLS();
    applySnapshot(snap, "redo");
  }

  function render(){
    screenTitle.textContent = (state.screen === "input") ? "入力" : "コピー";
    countLabel.textContent = `件数：${activeCount()}`;

    navInput.classList.toggle("active", state.screen === "input");
    navCopy.classList.toggle("active", state.screen === "copy");

    content.innerHTML = "";
    if(state.screen === "input"){
      content.appendChild(renderInputScreen());
    }else{
      content.appendChild(renderCopyScreen());
    }
  }

  function renderInputScreen(){
    const wrap = document.createElement("div");
    wrap.className = "pasteWrap";

    const c1 = document.createElement("div");
    c1.className = "card";
    c1.innerHTML = `
      <div class="pasteLabel">入力（貼り付け → 反映）</div>
      <textarea id="pasteArea" placeholder="例：VMA1069413711  8p7s@3WD"></textarea>
      <div class="actions2">
        <button class="btn primary" id="btnApply">貼り付け反映</button>
        <button class="btn" id="btnCopyTSV">データをコピー（TSV）</button>
      </div>
    `;
    wrap.appendChild(c1);

    const table = document.createElement("div");
    table.className = "card tableCard";

    const thead = document.createElement("div");
    thead.className = "thead";
    const trh = document.createElement("div");
    trh.className = "tr";
    trh.innerHTML = `
      <div>#</div>
      <div>ID</div>
      <div></div>
      <div>PIN</div>
      <div></div>
    `;
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("div");
    tbody.className = "tbody";

    for(let i=0;i<MAX_ROWS;i++){
      const r = state.rows[i];

      const tr = document.createElement("div");
      tr.className = "tr";
      tr.dataset.idx = String(i);

      const num = document.createElement("div");
      num.className = "numCell";
      const badge = document.createElement("div");
      badge.className = "numBadge";
      badge.textContent = String(i+1);

      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.textContent = String(r.editCount ?? 0);
      ghost.style.color = ghostColor(r.editCount ?? 0);

      num.appendChild(ghost);
      num.appendChild(badge);

      const idCell = document.createElement("div");
      idCell.className = "valCell";
      const idInput = document.createElement("input");
      idInput.className = "field";
      idInput.type = "text";
      idInput.autocapitalize = "off";
      idInput.autocomplete = "off";
      idInput.spellcheck = false;
      idInput.value = r.id || "";
      idInput.dataset.role = "id";
      attachSelectAllBehavior(idInput);
      idCell.appendChild(idInput);

      const pinCell = document.createElement("div");
      pinCell.className = "valCell";
      const pinInput = document.createElement("input");
      pinInput.className = "field";
      pinInput.type = "text";
      pinInput.autocapitalize = "off";
      pinInput.autocomplete = "off";
      pinInput.spellcheck = false;
      pinInput.value = r.pin || "";
      pinInput.dataset.role = "pin";
      attachSelectAllBehavior(pinInput);
      pinCell.appendChild(pinInput);

      /* 入力シート：コピーボタン（復活） */
      const idCopy = document.createElement("div");
      idCopy.className = "copyBtn";
      idCopy.textContent = "コピー";

      const pinCopy = document.createElement("div");
      pinCopy.className = "copyBtn";
      pinCopy.textContent = "コピー";

      /* 反映していない（空）の状態ではコピー不可 */
      if(!r.id) idCopy.classList.add("disabled");
      if(!r.pin) pinCopy.classList.add("disabled");

      tr.appendChild(num);
      tr.appendChild(idCell);
      tr.appendChild(idCopy);
      tr.appendChild(pinCell);
      tr.appendChild(pinCopy);
      tbody.appendChild(tr);

      idInput.addEventListener("blur", () => {
        const nv = idInput.value.trim();
        const was = state.rows[i].id || "";
        if(nv !== was){
          pushHistory("edit_id");
          state.rows[i].id = nv;
          commitIdEdit(i, nv);

          ghost.textContent = String(state.rows[i].editCount ?? 0);
          ghost.style.color = ghostColor(state.rows[i].editCount ?? 0);

          idCopy.classList.toggle("disabled", !nv);
          countLabel.textContent = `件数：${activeCount()}`;
        }
      });

      pinInput.addEventListener("blur", () => {
        const nv = pinInput.value.trim();
        const was = state.rows[i].pin || "";
        if(nv !== was){
          pushHistory("edit_pin");
          state.rows[i].pin = nv;

          pinCopy.classList.toggle("disabled", !nv);
          countLabel.textContent = `件数：${activeCount()}`;
        }
      });

      idCopy.addEventListener("click", async () => {
        const v = state.rows[i].id || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(idCell);
          showToast("IDをコピーしました");
        }else{
          showToast("コピー失敗");
        }
      });

      pinCopy.addEventListener("click", async () => {
        const v = state.rows[i].pin || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(pinCell);
          showToast("PINをコピーしました");
        }else{
          showToast("コピー失敗");
        }
      });
    }

    table.appendChild(tbody);
    wrap.appendChild(table);

    const pasteArea = c1.querySelector("#pasteArea");
    const btnApply = c1.querySelector("#btnApply");
    const btnCopy = c1.querySelector("#btnCopyTSV");

    btnApply.addEventListener("click", () => applyPasted(pasteArea.value));
    btnCopy.addEventListener("click", () => copyTSV());

    return wrap;
  }

  function renderCopyScreen(){
    const wrap = document.createElement("div");
    wrap.className = "copyMode";

    const table = document.createElement("div");
    table.className = "card tableCard";

    const thead = document.createElement("div");
    thead.className = "thead";
    const trh = document.createElement("div");
    trh.className = "tr";
    trh.innerHTML = `
      <div>#</div>
      <div>ID</div>
      <div>PIN</div>
    `;
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("div");
    tbody.className = "tbody";

    const rows = state.rows
      .map((r, idx) => ({...r, idx}))
      .filter(x => (x.id || x.pin));

    if(rows.length === 0){
      const empty = document.createElement("div");
      empty.className = "card";
      empty.style.textAlign = "center";
      empty.style.color = "#64748b";
      empty.style.fontWeight = "900";
      empty.textContent = "データがありません（入力で貼り付け反映してください）";
      wrap.appendChild(empty);
      return wrap;
    }

    for(const x of rows){
      const tr = document.createElement("div");
      tr.className = "tr";

      const num = document.createElement("div");
      num.className = "numCell";
      const badge = document.createElement("div");
      badge.className = "numBadge";
      badge.textContent = String(x.idx + 1);

      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.textContent = String(x.editCount ?? 0);
      ghost.style.color = ghostColor(x.editCount ?? 0);

      num.appendChild(ghost);
      num.appendChild(badge);

      const idTap = document.createElement("div");
      idTap.className = "copyTap";
      idTap.textContent = x.id || "";

      const pinTap = document.createElement("div");
      pinTap.className = "copyTap";
      pinTap.textContent = x.pin || "";

      idTap.addEventListener("click", async () => {
        const v = x.id || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(idTap);
          showToast("IDをコピーしました");
        }else{
          showToast("コピー失敗");
        }
      });

      pinTap.addEventListener("click", async () => {
        const v = x.pin || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(pinTap);
          showToast("PINをコピーしました");
        }else{
          showToast("コピー失敗");
        }
      });

      tr.appendChild(num);
      tr.appendChild(idTap);
      tr.appendChild(pinTap);
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  function go(screen){
    if(state.screen === screen) return;
    state.screen = screen;
    render();
  }

  btnSave.addEventListener("click", saveToLS);
  btnLoad.addEventListener("click", loadFromLS);
  btnClear.addEventListener("click", clearAll);
  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);
  navInput.addEventListener("click", () => go("input"));
  navCopy.addEventListener("click", () => go("copy"));

  function init(){
    state.rows = makeEmptyRows();
    loadHistoryFromLS();

    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if(raw){
        const payload = JSON.parse(raw);
        if(payload && Array.isArray(payload.rows)){
          for(let i=0;i<Math.min(MAX_ROWS, payload.rows.length);i++){
            const r = payload.rows[i];
            state.rows[i].id = (r.id ?? "");
            state.rows[i].pin = (r.pin ?? "");
            state.rows[i].editCount = (r.editCount ?? 0);
            state.rows[i].lastCommittedId = (r.lastCommittedId ?? state.rows[i].id);
          }
        }
      }
    }catch(e){}

    syncUndoRedoButtons();
    render();
  }

  init();
})();
</script>
</body>
</html>
