<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ID / PIN</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --head:#f3f4f6;

      --btn:#111827;
      --btnText:#ffffff;
      --btnSub:#eef2ff;
      --btnSubText:#1f2937;

      --danger:#fee2e2;
      --dangerText:#7f1d1d;

      /* ã‚³ãƒ”ãƒ¼å¼·èª¿ï¼ˆæ¿ƒã„ï¼‰ */
      --flash:#111827;
      --flashText:#ffffff;
      --flashOutline:#111827;

      /* #åˆ— èƒŒæ™¯æ•°å­—ã®æ¿ƒã• */
      --ghostOpacity:0.11;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Noto Sans JP","Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      overscroll-behavior-y:contain;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:12px 12px calc(84px + env(safe-area-inset-bottom));
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:10;
      padding:10px 0;
      background:linear-gradient(to bottom, var(--bg) 70%, rgba(246,247,249,0));
      backdrop-filter:saturate(140%) blur(8px);
    }

    .topbar .left, .topbar .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    button{
      appearance:none;
      border:1px solid transparent;
      background:var(--btn);
      color:var(--btnText);
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    button.secondary{
      background:var(--btnSub);
      color:var(--btnSubText);
      border-color:#c7d2fe;
      font-weight:800;
    }
    button.danger{
      background:var(--danger);
      color:var(--dangerText);
      border-color:#fecaca;
      font-weight:900;
    }
    button.icon{
      width:40px;
      padding:10px 0;
      text-align:center;
      font-size:16px;
    }
    button:disabled{opacity:.40; cursor:not-allowed;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .stack{display:grid; gap:12px;}

    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      font-size:15px;
      line-height:1.4;
      outline:none;
      background:#fff;
    }
    textarea:focus{border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15);}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .row .btns{display:flex; gap:10px; flex-wrap:wrap;}

    /* ===== ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡ã—ï¼‰ ===== */
    .table{
      width:100%;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .thead, .tr{
      display:grid;
      grid-template-columns: 40px 1fr 32px 0.85fr 32px; /* # / ID / copy / PIN / copy */
      align-items:center;
    }
    .thead{
      background:var(--head);
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:#374151;
      font-weight:900;
    }
    .thead div{padding:10px 10px;}
    .tr{
      border-bottom:1px solid var(--line);
      min-height:54px;
    }
    .tr:last-child{border-bottom:none;}
    .cell{padding:10px 10px; min-width:0;}

    /* #åˆ—ï¼šç‹­ã„ï¼‹èƒŒæ™¯ã«è–„ã„æ•°å­— */
    .numCell{
      position:relative;
      padding:0;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#111827;
      z-index:1;
    }
    .numCell .numFront{
      position:relative;
      z-index:2;
      font-size:14px;
    }
    .numCell .ghost{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:28px;
      letter-spacing:-0.02em;
      opacity:var(--ghostOpacity);
      z-index:1;
      pointer-events:none;
      transform:translateY(1px);
    }

    .idInput, .pinInput{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      font-size:15px;
      font-weight:800;
      padding:8px 10px;
      border-radius:12px;
      outline:none;
      min-width:0;
    }
    .pinInput{font-weight:900;}
    .idInput:focus, .pinInput:focus{
      border-color:#c7d2fe;
      background:#fff;
      box-shadow:0 0 0 3px rgba(99,102,241,.15);
    }

    .copyMini{
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
      padding:0;
      margin:0;
    }
    .copyMini button{
      width:28px;
      height:28px;
      padding:0;
      border-radius:10px;
      font-size:14px;
      font-weight:900;
    }
    .copyMini button.secondary{
      background:#eef2ff;
      border-color:#c7d2fe;
    }

    /* ã‚³ãƒ”ãƒ¼æ™‚ï¼šã‚»ãƒ«å˜ç‹¬ã§æ¿ƒã */
    .flashWrap{
      background:var(--flash) !important;
      color:var(--flashText) !important;
    }
    .flashWrap input{
      color:var(--flashText) !important;
      background:transparent !important;
    }

    /* ===== ã‚³ãƒ”ãƒ¼ç”»é¢ï¼ˆæƒ…å ±å°‘ãªã‚ï¼‰ ===== */
    .simpleHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin:0 0 10px 0;
      font-weight:900;
    }
    .simpleHeader .title{font-size:16px;}
    .simpleHeader .count{font-size:12px; color:var(--muted); font-weight:900;}

    /* ç”»é¢åˆ‡æ›¿ï¼ˆä¸‹ã‚¿ãƒ–ï¼‰ */
    .tabbar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(246,247,249,.92);
      backdrop-filter:saturate(140%) blur(10px);
      border-top:1px solid var(--line);
    }
    .tabs{
      max-width:980px;
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .tabBtn{
      border-radius:16px;
      padding:14px 12px;
      font-size:16px;
      font-weight:900;
    }
    .tabBtn.secondary{
      background:#fff;
      border:1px solid var(--line);
      color:#111827;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:92px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    @media (max-width:420px){
      .thead, .tr{ grid-template-columns: 34px 1fr 28px 0.9fr 28px; }
      .numCell .ghost{font-size:24px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <button id="btnSave">ä¿å­˜</button>
        <button id="btnLoad" class="secondary">èª­è¾¼</button>
        <button id="btnClear" class="danger">å…¨å‰Šé™¤</button>
      </div>
      <div class="right">
        <button id="btnUndo" class="secondary icon" title="æˆ»ã‚‹">â†</button>
        <button id="btnRedo" class="secondary icon" title="é€²ã‚€">â†’</button>
      </div>
    </div>

    <!-- å…¥åŠ›ç”»é¢ -->
    <section id="viewInput" class="stack">
      <div class="card stack">
        <textarea id="pasteBox" placeholder="ã“ã“ã«ã€ID PINã€ã‚’è¤‡æ•°è¡Œã§è²¼ã‚Šä»˜ã‘ â†’ ã€è²¼ã‚Šä»˜ã‘åæ˜ ã€"></textarea>
        <div class="row">
          <div class="btns">
            <button id="btnApply">è²¼ã‚Šä»˜ã‘åæ˜ </button>
            <button id="btnCopyTSV" class="secondary">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆTSVï¼‰</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="table">
          <div class="thead">
            <div>#</div>
            <div>ID</div>
            <div></div>
            <div>PIN</div>
            <div></div>
          </div>
          <div id="tbody"></div>
        </div>
      </div>
    </section>

    <!-- ã‚³ãƒ”ãƒ¼ç”»é¢ -->
    <section id="viewCopy" class="stack" style="display:none;">
      <div class="card">
        <div class="simpleHeader">
          <div class="title">ID / PIN</div>
          <div class="count" id="copyCount">ä»¶æ•°ï¼š0</div>
        </div>

        <div class="table">
          <div class="thead">
            <div>#</div>
            <div>ID</div>
            <div></div>
            <div>PIN</div>
            <div></div>
          </div>
          <div id="tbodyCopy"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="tabbar">
    <div class="tabs">
      <button id="tabInput" class="tabBtn">å…¥åŠ›</button>
      <button id="tabCopy" class="tabBtn secondary">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div id="toast" class="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

<script>
/* ==========
  çŠ¶æ…‹
========== */
const LS_KEY   = "copy_app_rows_index_only_v1";
const LS_PASTE = "copy_app_paste_index_only_v1";

let rows = [];
let undoStack = [];
let redoStack = [];
const UNDO_LIMIT = 50;

const el = (id) => document.getElementById(id);

const viewInput = el("viewInput");
const viewCopy  = el("viewCopy");
const tabInput  = el("tabInput");
const tabCopy   = el("tabCopy");

const pasteBox  = el("pasteBox");
const tbody     = el("tbody");
const tbodyCopy = el("tbodyCopy");

const btnSave    = el("btnSave");
const btnLoad    = el("btnLoad");
const btnClear   = el("btnClear");
const btnApply   = el("btnApply");
const btnCopyTSV = el("btnCopyTSV");
const btnUndo    = el("btnUndo");
const btnRedo    = el("btnRedo");

const copyCount  = el("copyCount");
const toast      = el("toast");

let toastTimer = null;

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toast.classList.remove("show"), 900);
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{
      document.execCommand("copy");
      document.body.removeChild(ta);
      return true;
    }catch(err){
      document.body.removeChild(ta);
      return false;
    }
  }
}

/* ==========
  Undo / Redo
========== */
function snapshot(){
  return JSON.stringify({ rows, paste: pasteBox.value ?? "" });
}
function pushUndo(){
  undoStack.push(snapshot());
  if(undoStack.length > UNDO_LIMIT) undoStack.shift();
  redoStack = [];
  refreshUndoRedo();
}
function restoreFrom(json){
  const obj = JSON.parse(json);
  rows = Array.isArray(obj.rows) ? obj.rows : [];
  pasteBox.value = obj.paste ?? "";
  renderAll();
  refreshUndoRedo();
}
function undo(){
  if(!undoStack.length) return;
  redoStack.push(snapshot());
  const prev = undoStack.pop();
  restoreFrom(prev);
}
function redo(){
  if(!redoStack.length) return;
  undoStack.push(snapshot());
  const next = redoStack.pop();
  restoreFrom(next);
}
function refreshUndoRedo(){
  btnUndo.disabled = (undoStack.length === 0);
  btnRedo.disabled = (redoStack.length === 0);
}

/* ==========
  #åˆ— èƒŒæ™¯æ•°å­—ã®è‰²
========== */
function ghostColorByCount(n){
  if(n <= 0) return "#6b7280";   // ã‚°ãƒ¬ãƒ¼
  if(n <= 3) return "#2563eb";   // é’
  if(n <= 6) return "#16a34a";   // ç·‘
  if(n <= 9) return "#ea580c";   // ã‚ªãƒ¬ãƒ³ã‚¸
  return "#dc2626";              // èµ¤
}

/* ==========
  ãƒ‘ãƒ¼ã‚¹ / TSV
========== */
function parseLinesToRows(text){
  const out = [];
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const line of lines){
    const parts = line.split(/\s+/);
    const id  = (parts[0] ?? "").trim();
    const pin = (parts[1] ?? "").trim();
    if(!id && !pin) continue;
    out.push({ id, pin, editCount: 0 });
  }
  return out;
}
function toTSV(){
  return rows.map(r => `${r.id}\t${r.pin}`).join("\n");
}

/* ==========
  ä¿å­˜ / èª­è¾¼ / å…¨å‰Šé™¤
========== */
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(rows));
  localStorage.setItem(LS_PASTE, pasteBox.value ?? "");
  showToast("ä¿å­˜ã—ã¾ã—ãŸ");
}
function load(){
  const s = localStorage.getItem(LS_KEY);
  const p = localStorage.getItem(LS_PASTE);
  rows = s ? JSON.parse(s) : [];
  pasteBox.value = p ?? "";
  renderAll();
  showToast("èª­è¾¼ã—ã¾ã—ãŸ");
}
function clearAll(){
  pushUndo();
  rows = [];
  pasteBox.value = "";
  renderAll();
  showToast("å…¨å‰Šé™¤");
}

/* ==========
  ç”»é¢åˆ‡æ›¿
========== */
function setView(which){
  const isInput = (which === "input");
  viewInput.style.display = isInput ? "" : "none";
  viewCopy.style.display  = isInput ? "none" : "";

  tabInput.classList.toggle("secondary", !isInput);
  tabCopy.classList.toggle("secondary", isInput);
}

/* ==========
  ã‚³ãƒ”ãƒ¼å¼·èª¿ï¼ˆã‚»ãƒ«å˜ç‹¬ï¼‰
========== */
function flashCell(wrapper){
  wrapper.classList.add("flashWrap");
  setTimeout(()=>wrapper.classList.remove("flashWrap"), 520);
}

/* ==========
  è¡Œãƒ¬ãƒ³ãƒ€ï¼ˆå…¥åŠ›ï¼‰
========== */
function renderRowInput(r, idx){
  const tr = document.createElement("div");
  tr.className = "tr";

  // #åˆ—ï¼ˆå‰é¢ç•ªå· + èƒŒæ™¯ç·¨é›†ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  const num = document.createElement("div");
  num.className = "cell numCell";

  const front = document.createElement("div");
  front.className = "numFront";
  front.textContent = String(idx + 1);

  const ghost = document.createElement("div");
  ghost.className = "ghost";
  ghost.textContent = String(r.editCount ?? 0);
  ghost.style.color = ghostColorByCount(Number(r.editCount ?? 0));

  num.appendChild(ghost);
  num.appendChild(front);

  // ID
  const idCell = document.createElement("div");
  idCell.className = "cell";
  const idInput = document.createElement("input");
  idInput.className = "idInput";
  idInput.value = r.id ?? "";
  idInput.inputMode = "text";
  idInput.autocapitalize = "none";
  idInput.autocomplete = "off";
  idInput.spellcheck = false;

  // â˜…åŒå€¤ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ï¼ˆfocusæ™‚ã«beforeã‚’ä¿å­˜ã€blurã§æ¯”è¼ƒï¼‰
  let idBefore = idInput.value;
  idInput.addEventListener("focus", ()=>{
    idBefore = (idInput.value ?? "");
  });
  idInput.addEventListener("blur", ()=>{
    const beforeTrim = (idBefore ?? "").trim();
    const afterTrim  = (idInput.value ?? "").trim();

    // å€¤ã®åæ˜ ï¼ˆæ–‡å­—ãã®ã‚‚ã®ã¯trimã—ãªã„ï¼å…¥åŠ›ã—ãŸé€šã‚Šä¿æŒï¼‰
    const afterRaw = (idInput.value ?? "");
    const prevRaw  = (rows[idx].id ?? "");
    if(prevRaw !== afterRaw){
      pushUndo();
      rows[idx].id = afterRaw;
    }

    // â˜…åŒã˜å€¤ãªã‚‰å¢—ã‚„ã•ãªã„ï¼ˆtrimåŒå£«ã§æ¯”è¼ƒï¼‰
    if(afterTrim !== beforeTrim){
      rows[idx].editCount = Number(rows[idx].editCount ?? 0) + 1;
      ghost.textContent = String(rows[idx].editCount);
      ghost.style.color = ghostColorByCount(rows[idx].editCount);
    }

    renderCopyOnly();
  });

  idCell.appendChild(idInput);

  // IDã‚³ãƒ”ãƒ¼ï¼ˆå…¥åŠ›ç”»é¢ã§ã‚‚ï¼‰
  const idCopyCell = document.createElement("div");
  idCopyCell.className = "cell copyMini";
  const btnIdCopy = document.createElement("button");
  btnIdCopy.className = "secondary";
  btnIdCopy.textContent = "ğŸ“‹";
  btnIdCopy.title = "IDã‚’ã‚³ãƒ”ãƒ¼";
  btnIdCopy.addEventListener("click", async ()=>{
    const ok = await copyText(rows[idx].id ?? "");
    if(ok){
      flashCell(idCell);
      showToast("IDã‚³ãƒ”ãƒ¼");
    }else{
      showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
    }
  });
  idCopyCell.appendChild(btnIdCopy);

  // PIN
  const pinCell = document.createElement("div");
  pinCell.className = "cell";
  const pinInput = document.createElement("input");
  pinInput.className = "pinInput";
  pinInput.value = r.pin ?? "";
  pinInput.inputMode = "text";
  pinInput.autocapitalize = "none";
  pinInput.autocomplete = "off";
  pinInput.spellcheck = false;

  let pinBefore = pinInput.value;
  pinInput.addEventListener("focus", ()=>{ pinBefore = (pinInput.value ?? ""); });
  pinInput.addEventListener("blur", ()=>{
    const afterRaw = (pinInput.value ?? "");
    const prevRaw  = (rows[idx].pin ?? "");
    if(prevRaw !== afterRaw){
      pushUndo();
      rows[idx].pin = afterRaw;
      renderCopyOnly();
    }
    // PINç·¨é›†ã§ã¯ editCount ã‚’å¢—ã‚„ã•ãªã„ï¼ˆä»•æ§˜ï¼šIDç·¨é›†ã ã‘ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  });

  pinCell.appendChild(pinInput);

  // PINã‚³ãƒ”ãƒ¼
  const pinCopyCell = document.createElement("div");
  pinCopyCell.className = "cell copyMini";
  const btnPinCopy = document.createElement("button");
  btnPinCopy.className = "secondary";
  btnPinCopy.textContent = "ğŸ“‹";
  btnPinCopy.title = "PINã‚’ã‚³ãƒ”ãƒ¼";
  btnPinCopy.addEventListener("click", async ()=>{
    const ok = await copyText(rows[idx].pin ?? "");
    if(ok){
      flashCell(pinCell);
      showToast("PINã‚³ãƒ”ãƒ¼");
    }else{
      showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
    }
  });
  pinCopyCell.appendChild(btnPinCopy);

  tr.appendChild(num);
  tr.appendChild(idCell);
  tr.appendChild(idCopyCell);
  tr.appendChild(pinCell);
  tr.appendChild(pinCopyCell);

  return tr;
}

/* ==========
  è¡Œãƒ¬ãƒ³ãƒ€ï¼ˆã‚³ãƒ”ãƒ¼ç”»é¢ï¼šç·¨é›†ä¸å¯ï¼‰
========== */
function renderRowCopy(r, idx){
  const tr = document.createElement("div");
  tr.className = "tr";

  const num = document.createElement("div");
  num.className = "cell numCell";

  const front = document.createElement("div");
  front.className = "numFront";
  front.textContent = String(idx + 1);

  const ghost = document.createElement("div");
  ghost.className = "ghost";
  ghost.textContent = String(r.editCount ?? 0);
  ghost.style.color = ghostColorByCount(Number(r.editCount ?? 0));

  num.appendChild(ghost);
  num.appendChild(front);

  const idCell = document.createElement("div");
  idCell.className = "cell";
  const idText = document.createElement("div");
  idText.style.fontWeight = "900";
  idText.style.padding = "8px 10px";
  idText.style.borderRadius = "12px";
  idText.style.userSelect = "text";
  idText.textContent = (r.id ?? "");
  idCell.appendChild(idText);

  const idCopyCell = document.createElement("div");
  idCopyCell.className = "cell copyMini";
  const btnIdCopy = document.createElement("button");
  btnIdCopy.className = "secondary";
  btnIdCopy.textContent = "ğŸ“‹";
  btnIdCopy.addEventListener("click", async ()=>{
    const ok = await copyText(r.id ?? "");
    if(ok){ flashCell(idCell); showToast("IDã‚³ãƒ”ãƒ¼"); }
    else{ showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—"); }
  });
  idCopyCell.appendChild(btnIdCopy);

  const pinCell = document.createElement("div");
  pinCell.className = "cell";
  const pinText = document.createElement("div");
  pinText.style.fontWeight = "900";
  pinText.style.padding = "8px 10px";
  pinText.style.borderRadius = "12px";
  pinText.style.userSelect = "text";
  pinText.textContent = (r.pin ?? "");
  pinCell.appendChild(pinText);

  const pinCopyCell = document.createElement("div");
  pinCopyCell.className = "cell copyMini";
  const btnPinCopy = document.createElement("button");
  btnPinCopy.className = "secondary";
  btnPinCopy.textContent = "ğŸ“‹";
  btnPinCopy.addEventListener("click", async ()=>{
    const ok = await copyText(r.pin ?? "");
    if(ok){ flashCell(pinCell); showToast("PINã‚³ãƒ”ãƒ¼"); }
    else{ showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—"); }
  });
  pinCopyCell.appendChild(btnPinCopy);

  tr.appendChild(num);
  tr.appendChild(idCell);
  tr.appendChild(idCopyCell);
  tr.appendChild(pinCell);
  tr.appendChild(pinCopyCell);

  return tr;
}

/* ==========
  ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========== */
function renderAll(){
  tbody.innerHTML = "";
  rows.forEach((r, i)=> tbody.appendChild(renderRowInput(r, i)));
  renderCopyOnly();
  copyCount.textContent = `ä»¶æ•°ï¼š${rows.length}`;
}
function renderCopyOnly(){
  tbodyCopy.innerHTML = "";
  rows.forEach((r,i)=> tbodyCopy.appendChild(renderRowCopy(r,i)));
  copyCount.textContent = `ä»¶æ•°ï¼š${rows.length}`;
}

/* ==========
  UIã‚¤ãƒ™ãƒ³ãƒˆ
========== */
tabInput.addEventListener("click", ()=>setView("input"));
tabCopy.addEventListener("click", ()=>setView("copy"));

btnSave.addEventListener("click", save);
btnLoad.addEventListener("click", load);
btnClear.addEventListener("click", clearAll);

btnUndo.addEventListener("click", undo);
btnRedo.addEventListener("click", redo);

btnApply.addEventListener("click", ()=>{
  const text = pasteBox.value ?? "";
  const parsed = parseLinesToRows(text);

  pushUndo();
  rows = parsed;

  renderAll();
  showToast("åæ˜ ã—ã¾ã—ãŸ");
});

btnCopyTSV.addEventListener("click", async ()=>{
  const tsv = toTSV();
  const ok = await copyText(tsv);
  if(ok) showToast("TSVã‚³ãƒ”ãƒ¼");
  else showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
});

/* ==========
  åˆæœŸåŒ–
========== */
(function init(){
  const s = localStorage.getItem(LS_KEY);
  const p = localStorage.getItem(LS_PASTE);
  if(s){
    try{ rows = JSON.parse(s) || []; }catch(e){ rows = []; }
  }
  if(p != null) pasteBox.value = p;

  renderAll();
  refreshUndoRedo();
  setView("input");
})();
</script>
</body>
</html>
