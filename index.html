<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ID / PIN</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5eaf2;
      --head:#f1f5f9;

      --primary:#0b1220;
      --primaryText:#ffffff;

      --dangerBg:#fde2e2;
      --dangerText:#b42318;

      --chip:#eef2ff;
      --chipLine:#c7d2fe;

      --focus:#c7d2fe;

      /* ã‚³ãƒ”ãƒ¼å¼·èª¿ï¼ˆè–„ã„é’ï¼‰ */
      --copiedBg:#dbeafe;   /* â†è–„ã„é’ */
      --copiedLine:#93c5fd;

      /* #åˆ— èƒŒæ™¯æ•°å­—ï¼ˆå°‘ã—æ¿ƒãï¼‰ */
      --ghostAlpha:0.22;    /* â†æ¿ƒã•èª¿æ•´ï¼ˆå¿…è¦ãªã‚‰ 0.18ã€œ0.30ï¼‰ */

      /* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…ï¼ˆIDã‚’åºƒãï¼‰ */
      --colNum:54px;
      --colId:1.7fr;
      --colPin:1.1fr;
      --colBtn:56px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      -webkit-font-smoothing:antialiased;
      overscroll-behavior-y:contain;
    }
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      padding:10px 12px 8px;
    }
    .toprow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btnrow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:700;
      letter-spacing:.01em;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:scale(.98);}
    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }
    .btn.danger{
      background:var(--dangerBg);
      color:var(--dangerText);
      border-color:transparent;
      font-weight:800;
    }
    .btn.icon{
      width:44px;height:44px;
      padding:0;
      display:grid;
      place-items:center;
      border-radius:14px;
      background:#eef2ff;
      border:1px solid #dbeafe;
      font-size:18px;
    }
    .btn:disabled{
      opacity:.45;
      filter:grayscale(.2);
      transform:none;
    }
    .titleline{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:18px;
      font-weight:900;
    }
    .count{
      font-size:14px;
      color:var(--muted);
      font-weight:800;
    }

    .content{
      width:min(980px,100%);
      margin:0 auto;
      padding:12px 12px 96px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }

    /* å…¥åŠ›ã‚·ãƒ¼ãƒˆï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ */
    .pasteWrap{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .pasteLabel{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
    }
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px;
      font-size:18px;
      line-height:1.35;
      outline:none;
      background:#fbfdff;
      -webkit-overflow-scrolling:touch;
    }
    textarea:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.35);
    }
    .actions2{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .actions2 .btn{
      flex:1;
      min-width:160px;
      padding:14px 16px;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
    .tableCard{
      padding:0;
      overflow:hidden;
    }
    .thead{
      background:var(--head);
      border-bottom:1px solid var(--line);
    }
    .tr{
      display:grid;
      grid-template-columns: var(--colNum) var(--colId) var(--colBtn) var(--colPin) var(--colBtn);
      align-items:center;
      gap:0;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
    }
    .thead .tr{
      padding:10px 10px;
      font-weight:900;
      color:#334155;
      font-size:14px;
    }
    .tbody .tr{
      background:var(--card);
    }
    .tbody .tr:last-child{border-bottom:none;}

    /* #åˆ—ï¼ˆãƒãƒƒã‚¸ + èƒŒæ™¯ã‚´ãƒ¼ã‚¹ãƒˆæ•°å­—ï¼‰ */
    .numCell{
      position:relative;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .numBadge{
      width:36px;height:36px;
      display:grid;
      place-items:center;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chipLine);
      font-weight:900;
      color:#0f172a;
      z-index:2;
    }
    .ghost{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:1000;
      font-size:38px;
      letter-spacing:-.04em;
      z-index:1;
      pointer-events:none;
      opacity:var(--ghostAlpha); /* â†æ¿ƒã• */
      transform:translateY(1px);
      filter:saturate(1.2);
    }

    /* å€¤ã‚»ãƒ«ï¼ˆå…¥åŠ›/è¡¨ç¤ºï¼‰ */
    .valCell{
      padding:0 8px;
      min-width:0;
    }
    .field{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      padding:12px 10px;
      border-radius:14px;
      font-size:22px;
      font-weight:900;
      outline:none;
      min-width:0;
    }
    .field::placeholder{color:#cbd5e1;font-weight:800;}
    .field:focus{
      background:#f8fafc;
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.35);
    }

    /* ã‚³ãƒ”ãƒ¼ç³»ï¼ˆå…¥åŠ›ã‚·ãƒ¼ãƒˆã®ã¿ï¼šãƒœã‚¿ãƒ³ï¼‰ */
    .copyBtn{
      width:44px;height:44px;
      margin:0 auto;
      border-radius:14px;
      border:1px solid #dbeafe;
      background:#eef2ff;
      display:grid;
      place-items:center;
      font-size:20px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .05s ease, filter .15s ease;
    }
    .copyBtn:active{transform:scale(.98);}
    .copyBtn.disabled{
      opacity:.35;
      filter:grayscale(.3);
      pointer-events:none;
    }

    /* ã‚³ãƒ”ãƒ¼ã‚·ãƒ¼ãƒˆï¼šã‚»ãƒ«ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼ˆãƒœã‚¿ãƒ³ç„¡ã—ï¼‰ */
    .copyMode .tr{
      grid-template-columns: var(--colNum) var(--colId) var(--colPin);
    }
    .copyMode .copyTap{
      border-radius:14px;
      padding:12px 10px;
      font-size:22px;
      font-weight:900;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:background .12s ease, box-shadow .12s ease;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .copyMode .copyTap:active{
      background:#eef2ff;
    }

    /* ã©ã®ã‚»ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸã‹ã®å¼·èª¿ï¼ˆè–„ã„é’ï¼‰ */
    .copied{
      background:var(--copiedBg) !important;
      box-shadow:inset 0 0 0 2px var(--copiedLine);
    }

    /* ä¸‹ãƒŠãƒ“ */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px 18px;
      background:rgba(245,247,251,.92);
      backdrop-filter:saturate(180%) blur(12px);
      border-top:1px solid var(--line);
      z-index:40;
    }
    .navInner{
      width:min(980px,100%);
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .navBtn{
      border-radius:22px;
      padding:16px 16px;
      font-size:20px;
      font-weight:1000;
      border:1px solid var(--line);
      background:var(--card);
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .navBtn.active{
      background:var(--primary);
      color:var(--primaryText);
      border-color:transparent;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:92px;
      background:#0b1220;
      color:white;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      z-index:60;
      max-width:min(92vw,520px);
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    @media (max-width:520px){
      :root{
        --colNum:52px;
        --colBtn:52px;
      }
      .field{font-size:20px;}
      .copyMode .copyTap{font-size:20px;}
    }
  </style>
</head>

<body>
<div class="app">
  <!-- Top -->
  <div class="topbar">
    <div class="toprow">
      <div class="btnrow">
        <button class="btn primary" id="btnSave">ä¿å­˜</button>
        <button class="btn" id="btnLoad">èª­è¾¼</button>
        <button class="btn danger" id="btnClear">å…¨å‰Šé™¤</button>
      </div>

      <div class="btnrow">
        <button class="btn icon" id="btnUndo" title="æˆ»ã‚‹" aria-label="æˆ»ã‚‹">â†</button>
        <button class="btn icon" id="btnRedo" title="é€²ã‚€" aria-label="é€²ã‚€">â†’</button>
      </div>
    </div>

    <div class="titleline">
      <div class="title" id="screenTitle">å…¥åŠ›</div>
      <div class="count" id="countLabel">ä»¶æ•°ï¼š0</div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content"></div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="navInner">
      <div class="navBtn active" id="navInput">å…¥åŠ›</div>
      <div class="navBtn" id="navCopy">ã‚³ãƒ”ãƒ¼</div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>
</div>

<script>
(() => {
  "use strict";

  // =========================
  // è¨­å®š
  // =========================
  const MAX_ROWS = 200;                // ãŸãã•ã‚“å…¥ã‚Œã¦ã‚‚ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã ã‘ã§å¯¾å¿œ
  const LS_KEY_DATA = "idpin_data_v3";
  const LS_KEY_HIST = "idpin_hist_v3";

  // =========================
  // çŠ¶æ…‹
  // =========================
  const state = {
    screen: "input", // "input" | "copy"
    rows: [],        // {id, pin, editCount, lastCommittedId}
    history: {
      undo: [],
      redo: []
    },
    lastCopiedEl: null,
    lastCopiedTimer: null,
  };

  // åˆæœŸ rows
  function makeEmptyRows(){
    const a = [];
    for(let i=0;i<MAX_ROWS;i++){
      a.push({ id:"", pin:"", editCount:0, lastCommittedId:"" });
    }
    return a;
  }

  // =========================
  // DOM
  // =========================
  const $ = (sel, root=document) => root.querySelector(sel);

  const content = $("#content");
  const screenTitle = $("#screenTitle");
  const countLabel = $("#countLabel");
  const toast = $("#toast");

  const btnSave = $("#btnSave");
  const btnLoad = $("#btnLoad");
  const btnClear = $("#btnClear");
  const btnUndo = $("#btnUndo");
  const btnRedo = $("#btnRedo");

  const navInput = $("#navInput");
  const navCopy  = $("#navCopy");

  // =========================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================
  function activeCount(){
    return state.rows.filter(r => (r.id || r.pin)).length;
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(state._toastTimer);
    state._toastTimer = setTimeout(() => toast.classList.remove("show"), 900);
  }

  async function copyText(text){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){ /* fallthrough */ }

    // fallback
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  function setCopiedHighlight(el){
    if(state.lastCopiedEl && state.lastCopiedEl !== el){
      state.lastCopiedEl.classList.remove("copied");
    }
    el.classList.add("copied");
    state.lastCopiedEl = el;

    clearTimeout(state.lastCopiedTimer);
    state.lastCopiedTimer = setTimeout(() => {
      if(state.lastCopiedEl){
        state.lastCopiedEl.classList.remove("copied");
        state.lastCopiedEl = null;
      }
    }, 700);
  }

  function ghostColor(editCount){
    // æ•°å­—ã«ã‚ˆã£ã¦è‰²ãŒå¤‰ã‚ã‚‹ï¼ˆèƒŒæ™¯ç”¨ï¼‰
    // â€»æ¿ƒã•ã¯CSSã® --ghostAlpha ã§èª¿æ•´
    const palette = [
      "#2563eb", // blue
      "#7c3aed", // purple
      "#db2777", // pink
      "#ea580c", // orange
      "#16a34a", // green
      "#0891b2", // cyan
      "#b45309", // amber
      "#334155"  // slate
    ];
    return palette[Math.abs(editCount) % palette.length];
  }

  function deepCloneRows(rows){
    return rows.map(r => ({
      id: r.id,
      pin: r.pin,
      editCount: r.editCount,
      lastCommittedId: r.lastCommittedId
    }));
  }

  function pushHistory(reason){
    // ç›´å‰çŠ¶æ…‹ã‚’undoã¸ç©ã‚€
    state.history.undo.push({
      t: Date.now(),
      reason,
      rows: deepCloneRows(state.rows)
    });
    // æ–°æ“ä½œã®ãŸã³ã«redoã¯ã‚¯ãƒªã‚¢
    state.history.redo = [];
    syncUndoRedoButtons();
    saveHistoryToLS();
  }

  function applySnapshot(snapshot, from){
    state.rows = deepCloneRows(snapshot.rows);
    syncUndoRedoButtons();
    render(); // ç”»é¢å†æç”»
    showToast(from === "undo" ? "æˆ»ã—ã¾ã—ãŸ" : "é€²ã‚ã¾ã—ãŸ");
  }

  function saveHistoryToLS(){
    try{
      const slim = {
        undo: state.history.undo.slice(-60), // 60æ‰‹ã¾ã§
        redo: state.history.redo.slice(-60)
      };
      localStorage.setItem(LS_KEY_HIST, JSON.stringify(slim));
    }catch(e){}
  }

  function loadHistoryFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_HIST);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && Array.isArray(obj.undo) && Array.isArray(obj.redo)){
        state.history.undo = obj.undo;
        state.history.redo = obj.redo;
      }
    }catch(e){}
  }

  function syncUndoRedoButtons(){
    btnUndo.disabled = state.history.undo.length === 0;
    btnRedo.disabled = state.history.redo.length === 0;
  }

  // =========================
  // ä¿å­˜/èª­è¾¼/å…¨å‰Šé™¤
  // =========================
  function saveToLS(){
    try{
      const payload = {
        v:3,
        savedAt: Date.now(),
        rows: deepCloneRows(state.rows)
      };
      localStorage.setItem(LS_KEY_DATA, JSON.stringify(payload));
      showToast("ä¿å­˜ã—ã¾ã—ãŸ");
    }catch(e){
      showToast("ä¿å­˜ã«å¤±æ•—");
    }
  }

  function loadFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if(!raw){ showToast("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
      const payload = JSON.parse(raw);
      if(!payload || !Array.isArray(payload.rows)){ showToast("èª­è¾¼å¤±æ•—"); return; }

      pushHistory("load");
      state.rows = makeEmptyRows();
      for(let i=0;i<Math.min(MAX_ROWS, payload.rows.length);i++){
        const r = payload.rows[i];
        state.rows[i].id = (r.id ?? "");
        state.rows[i].pin = (r.pin ?? "");
        state.rows[i].editCount = (r.editCount ?? 0);
        state.rows[i].lastCommittedId = (r.lastCommittedId ?? state.rows[i].id);
      }
      render();
      showToast("èª­è¾¼ã—ã¾ã—ãŸ");
    }catch(e){
      showToast("èª­è¾¼ã«å¤±æ•—");
    }
  }

  function clearAll(){
    pushHistory("clear");
    state.rows = makeEmptyRows();
    render();
    showToast("å…¨å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  // =========================
  // å…¥åŠ›ï¼ˆè²¼ã‚Šä»˜ã‘ â†’ åæ˜ ï¼‰
  // =========================
  function parsePasted(text){
    // 1è¡Œ:  ID<ç©ºç™½/ã‚¿ãƒ–>PIN
    // ç©ºè¡Œã¯ç„¡è¦–
    const lines = (text || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      // é€£ç¶šç©ºç™½/ã‚¿ãƒ–ã§åˆ†å‰²
      const parts = line.split(/\s+/);
      const id = parts[0] ?? "";
      const pin = parts[1] ?? "";
      if(id || pin) out.push({id, pin});
    }
    return out;
  }

  function applyPasted(text){
    const parsed = parsePasted(text);
    pushHistory("apply_paste");

    // å…¨ç½®æ›ï¼ˆç·¨é›†å›æ•°ã¯åˆæœŸåŒ–ï¼‰
    state.rows = makeEmptyRows();
    for(let i=0;i<Math.min(MAX_ROWS, parsed.length);i++){
      state.rows[i].id = parsed[i].id;
      state.rows[i].pin = parsed[i].pin;
      state.rows[i].editCount = 0;
      state.rows[i].lastCommittedId = parsed[i].id; // åŒå€¤ç·¨é›†ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ãŸã‚ã®åŸºæº–
    }
    render();
    showToast("è²¼ã‚Šä»˜ã‘åæ˜ ã—ã¾ã—ãŸ");
  }

  // =========================
  // TSVã‚³ãƒ”ãƒ¼ï¼ˆæ›¸ãå‡ºã—ï¼‰
  // =========================
  function buildTSV(){
    const rows = state.rows.filter(r => (r.id || r.pin));
    // ãƒ˜ãƒƒãƒ€ã¯å¥½ã¿ã«ã‚ˆã‚Šç„¡ã—ã§ã‚‚OKã€‚ä»Šå›ã¯â€œæ‰±ã„ã‚„ã™ã•å„ªå…ˆã§ç„¡ã—â€
    return rows.map(r => `${r.id}\t${r.pin}`).join("\n");
  }

  async function copyTSV(){
    const tsv = buildTSV();
    if(!tsv){
      showToast("ãƒ‡ãƒ¼ã‚¿ãªã—");
      return;
    }
    const ok = await copyText(tsv);
    showToast(ok ? "TSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼å¤±æ•—");
  }

  // =========================
  // è¡Œç·¨é›†ï¼šIDç·¨é›†å›æ•°ã‚®ãƒŸãƒƒã‚¯
  // =========================
  function commitIdEdit(rowIndex, newId){
    const r = state.rows[rowIndex];
    const prevCommitted = r.lastCommittedId ?? "";
    const next = newId ?? "";

    // åŒå€¤ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
    if(next !== prevCommitted){
      r.editCount = (r.editCount ?? 0) + 1;
      r.lastCommittedId = next;
    }
  }

  // =========================
  // â€œæœ€åˆã®ã‚¿ãƒƒãƒ—ã§å…¨é¸æŠâ€ å¯¾ç­–ï¼ˆiOSï¼‰
  // =========================
  function attachSelectAllBehavior(inputEl){
    // pointerdown / touchstart ã§ â€œæ¬¡ã®focusã§å…¨é¸æŠâ€ ã‚’äºˆç´„
    inputEl.addEventListener("pointerdown", () => {
      inputEl.dataset.sel = "1";
    }, {passive:true});

    inputEl.addEventListener("focus", () => {
      if(inputEl.dataset.sel === "1"){
        // iOSã¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚·ãƒ“ã‚¢ãªã®ã§å°‘ã—é…ã‚‰ã›ã‚‹
        requestAnimationFrame(() => {
          try{
            inputEl.setSelectionRange(0, inputEl.value.length);
          }catch(e){}
          inputEl.dataset.sel = "0";
        });
      }
    });
  }

  // =========================
  // Undo/Redo
  // =========================
  function undo(){
    if(state.history.undo.length === 0) return;
    const snap = state.history.undo.pop();
    // ç¾åœ¨ã‚’redoã¸
    state.history.redo.push({ t: Date.now(), reason:"redo_from_undo", rows: deepCloneRows(state.rows) });
    saveHistoryToLS();
    applySnapshot(snap, "undo");
  }

  function redo(){
    if(state.history.redo.length === 0) return;
    const snap = state.history.redo.pop();
    // ç¾åœ¨ã‚’undoã¸
    state.history.undo.push({ t: Date.now(), reason:"undo_from_redo", rows: deepCloneRows(state.rows) });
    saveHistoryToLS();
    applySnapshot(snap, "redo");
  }

  // =========================
  // ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  // =========================
  function render(){
    // header
    screenTitle.textContent = (state.screen === "input") ? "å…¥åŠ›" : "ã‚³ãƒ”ãƒ¼";
    countLabel.textContent = `ä»¶æ•°ï¼š${activeCount()}`;

    // nav active
    navInput.classList.toggle("active", state.screen === "input");
    navCopy.classList.toggle("active", state.screen === "copy");

    // content
    content.innerHTML = "";
    if(state.screen === "input"){
      content.appendChild(renderInputScreen());
    }else{
      content.appendChild(renderCopyScreen());
    }
  }

  function renderInputScreen(){
    const wrap = document.createElement("div");
    wrap.className = "pasteWrap";

    // è²¼ã‚Šä»˜ã‘ã‚«ãƒ¼ãƒ‰
    const c1 = document.createElement("div");
    c1.className = "card";
    c1.innerHTML = `
      <div class="pasteLabel">å…¥åŠ›ï¼ˆè²¼ã‚Šä»˜ã‘ â†’ åæ˜ ï¼‰</div>
      <textarea id="pasteArea" hint="è²¼ã‚Šä»˜ã‘"></textarea>
      <div class="actions2">
        <button class="btn primary" id="btnApply">è²¼ã‚Šä»˜ã‘åæ˜ </button>
        <button class="btn" id="btnCopyTSV">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆTSVï¼‰</button>
      </div>
    `;
    wrap.appendChild(c1);

    // ãƒ†ãƒ¼ãƒ–ãƒ«
    const table = document.createElement("div");
    table.className = "card tableCard";

    // thead
    const thead = document.createElement("div");
    thead.className = "thead";
    const trh = document.createElement("div");
    trh.className = "tr";
    trh.innerHTML = `
      <div>#</div>
      <div>ID</div>
      <div></div>
      <div>PIN</div>
      <div></div>
    `;
    thead.appendChild(trh);
    table.appendChild(thead);

    // tbody
    const tbody = document.createElement("div");
    tbody.className = "tbody";

    for(let i=0;i<MAX_ROWS;i++){
      const r = state.rows[i];

      const tr = document.createElement("div");
      tr.className = "tr";
      tr.dataset.idx = String(i);

      // #ã‚»ãƒ«
      const num = document.createElement("div");
      num.className = "numCell";
      const badge = document.createElement("div");
      badge.className = "numBadge";
      badge.textContent = String(i+1);

      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.textContent = String(r.editCount ?? 0);
      ghost.style.color = ghostColor(r.editCount ?? 0);

      num.appendChild(ghost);
      num.appendChild(badge);

      // IDå…¥åŠ›
      const idCell = document.createElement("div");
      idCell.className = "valCell";
      const idInput = document.createElement("input");
      idInput.className = "field";
      idInput.type = "text";
      idInput.inputMode = "text";
      idInput.autocapitalize = "off";
      idInput.autocomplete = "off";
      idInput.spellcheck = false;
      idInput.value = r.id || "";
      idInput.placeholder = "";
      idInput.dataset.role = "id";
      attachSelectAllBehavior(idInput);

      // PINå…¥åŠ›
      const pinCell = document.createElement("div");
      pinCell.className = "valCell";
      const pinInput = document.createElement("input");
      pinInput.className = "field";
      pinInput.type = "text";
      pinInput.inputMode = "text";
      pinInput.autocapitalize = "off";
      pinInput.autocomplete = "off";
      pinInput.spellcheck = false;
      pinInput.value = r.pin || "";
      pinInput.placeholder = "";
      pinInput.dataset.role = "pin";
      attachSelectAllBehavior(pinInput);

      idCell.appendChild(idInput);
      pinCell.appendChild(pinInput);

      // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå…¥åŠ›ã‚·ãƒ¼ãƒˆã¯ãƒœã‚¿ãƒ³OKï¼‰
      const idCopy = document.createElement("div");
      idCopy.className = "copyBtn";
      idCopy.textContent = "ğŸ“‹";
      const pinCopy = document.createElement("div");
      pinCopy.className = "copyBtn";
      pinCopy.textContent = "ğŸ“‹";

      // ã€Œåæ˜ ã—ã¦ãªãã¦ã‚‚ã‚³ãƒ”ãƒ¼ã§ãã‚‹ã€ãŒNG â†’ å€¤ãŒç©ºãªã‚‰ç„¡åŠ¹
      if(!r.id) idCopy.classList.add("disabled");
      if(!r.pin) pinCopy.classList.add("disabled");

      tr.appendChild(num);
      tr.appendChild(idCell);
      tr.appendChild(idCopy);
      tr.appendChild(pinCell);
      tr.appendChild(pinCopy);
      tbody.appendChild(tr);

      // ã‚¤ãƒ™ãƒ³ãƒˆï¼šID/PINç·¨é›†ï¼ˆè»½é‡åŒ–ã®ãŸã‚æœ€å°é™ï¼‰
      let idBefore = r.id || "";
      idInput.addEventListener("focus", () => { idBefore = idInput.value; }, {passive:true});
      idInput.addEventListener("blur", () => {
        const nv = idInput.value.trim();
        // å¤‰æ›´ãŒç¢ºå®šã—ãŸã‚‰å±¥æ­´ã‚’ç©ã‚€ï¼ˆãŸã ã—åŒå€¤ãªã‚‰ç©ã¾ãªã„ï¼‰
        const was = state.rows[i].id || "";
        if(nv !== was){
          pushHistory("edit_id");
          state.rows[i].id = nv;
          commitIdEdit(i, nv);

          // è¡¨ç¤ºæ›´æ–°ï¼ˆã“ã®è¡Œã ã‘ï¼‰
          ghost.textContent = String(state.rows[i].editCount ?? 0);
          ghost.style.color = ghostColor(state.rows[i].editCount ?? 0);
          idCopy.classList.toggle("disabled", !nv);
          countLabel.textContent = `ä»¶æ•°ï¼š${activeCount()}`;
        }
      });

      pinInput.addEventListener("blur", () => {
        const nv = pinInput.value.trim();
        const was = state.rows[i].pin || "";
        if(nv !== was){
          pushHistory("edit_pin");
          state.rows[i].pin = nv;
          pinCopy.classList.toggle("disabled", !nv);
          countLabel.textContent = `ä»¶æ•°ï¼š${activeCount()}`;
        }
      });

      // ã‚³ãƒ”ãƒ¼ï¼ˆå…¥åŠ›ã‚·ãƒ¼ãƒˆï¼šãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼‰
      idCopy.addEventListener("click", async () => {
        const v = state.rows[i].id || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(idCell);
          showToast("IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }else{
          showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
        }
      });

      pinCopy.addEventListener("click", async () => {
        const v = state.rows[i].pin || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(pinCell);
          showToast("PINã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }else{
          showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
        }
      });
    }

    table.appendChild(tbody);
    wrap.appendChild(table);

    // å…¥åŠ›ã‚«ãƒ¼ãƒ‰æ“ä½œ
    const pasteArea = c1.querySelector("#pasteArea");
    const btnApply = c1.querySelector("#btnApply");
    const btnCopy = c1.querySelector("#btnCopyTSV");

    btnApply.addEventListener("click", () => applyPasted(pasteArea.value));
    btnCopy.addEventListener("click", () => copyTSV());

    return wrap;
  }

  function renderCopyScreen(){
    // ã‚³ãƒ”ãƒ¼ã‚·ãƒ¼ãƒˆã¯ã€Œã‚»ãƒ«ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ã€ã€ŒUIã¯å…¥åŠ›ã¨åˆ¥ã€ã€Œãƒœã‚¿ãƒ³ç„¡ã—ã€
    const wrap = document.createElement("div");
    wrap.className = "copyMode";

    const table = document.createElement("div");
    table.className = "card tableCard";

    const thead = document.createElement("div");
    thead.className = "thead";
    const trh = document.createElement("div");
    trh.className = "tr";
    trh.innerHTML = `
      <div>#</div>
      <div>ID</div>
      <div>PIN</div>
    `;
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("div");
    tbody.className = "tbody";

    // è¡¨ç¤ºã¯ã€Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹è¡Œã ã‘ã€ã«ã—ã¦ã‚¹ãƒƒã‚­ãƒª
    const rows = state.rows
      .map((r, idx) => ({...r, idx}))
      .filter(x => (x.id || x.pin));

    if(rows.length === 0){
      const empty = document.createElement("div");
      empty.className = "card";
      empty.style.textAlign = "center";
      empty.style.color = "#64748b";
      empty.style.fontWeight = "900";
      empty.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¥åŠ›ã§è²¼ã‚Šä»˜ã‘åæ˜ ã—ã¦ãã ã•ã„ï¼‰";
      wrap.appendChild(empty);
      return wrap;
    }

    for(const x of rows){
      const tr = document.createElement("div");
      tr.className = "tr";
      tr.dataset.idx = String(x.idx);

      // #
      const num = document.createElement("div");
      num.className = "numCell";
      const badge = document.createElement("div");
      badge.className = "numBadge";
      badge.textContent = String(x.idx + 1);

      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.textContent = String(x.editCount ?? 0);
      ghost.style.color = ghostColor(x.editCount ?? 0);

      num.appendChild(ghost);
      num.appendChild(badge);

      // ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼ˆID / PINï¼‰
      const idTap = document.createElement("div");
      idTap.className = "copyTap";
      idTap.textContent = x.id || "";
      idTap.title = "ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼";
      idTap.dataset.role = "id";

      const pinTap = document.createElement("div");
      pinTap.className = "copyTap";
      pinTap.textContent = x.pin || "";
      pinTap.title = "ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼";
      pinTap.dataset.role = "pin";

      // ã‚¯ãƒªãƒƒã‚¯ â†’ ãã®ã‚»ãƒ«ã ã‘ã‚³ãƒ”ãƒ¼ï¼ˆå¼·èª¿ã‚‚ãã®ã‚»ãƒ«ã ã‘ï¼‰
      idTap.addEventListener("click", async () => {
        const v = x.id || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(idTap);
          showToast("IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }else{
          showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
        }
      });

      pinTap.addEventListener("click", async () => {
        const v = x.pin || "";
        if(!v) return;
        const ok = await copyText(v);
        if(ok){
          setCopiedHighlight(pinTap);
          showToast("PINã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }else{
          showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—");
        }
      });

      tr.appendChild(num);
      tr.appendChild(idTap);
      tr.appendChild(pinTap);
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  // =========================
  // ç”»é¢åˆ‡æ›¿
  // =========================
  function go(screen){
    if(state.screen === screen) return;
    state.screen = screen;
    render();
  }

  // =========================
  // ã‚¯ãƒªãƒƒã‚¯ç³»
  // =========================
  btnSave.addEventListener("click", saveToLS);
  btnLoad.addEventListener("click", loadFromLS);
  btnClear.addEventListener("click", clearAll);

  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);

  navInput.addEventListener("click", () => go("input"));
  navCopy.addEventListener("click", () => go("copy"));

  // =========================
  // åˆæœŸåŒ–
  // =========================
  function init(){
    state.rows = makeEmptyRows();
    loadHistoryFromLS();

    // åˆå›ï¼šä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•èª­è¾¼ï¼ˆä»»æ„ï¼‰
    try{
      const raw = localStorage.getItem(LS_KEY_DATA);
      if(raw){
        const payload = JSON.parse(raw);
        if(payload && Array.isArray(payload.rows)){
          for(let i=0;i<Math.min(MAX_ROWS, payload.rows.length);i++){
            const r = payload.rows[i];
            state.rows[i].id = (r.id ?? "");
            state.rows[i].pin = (r.pin ?? "");
            state.rows[i].editCount = (r.editCount ?? 0);
            state.rows[i].lastCommittedId = (r.lastCommittedId ?? state.rows[i].id);
          }
        }
      }
    }catch(e){}

    syncUndoRedoButtons();
    render();
  }

  init();
})();
</script>
</body>
</html>
