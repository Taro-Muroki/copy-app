<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ID / PIN</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#101828;
      --muted:#667085;
      --line:#e5e7eb;
      --head:#f2f4f7;

      /* コピー成功の強調（濃いめ） */
      --flash-bg:#0ea5e9;
      --flash-text:#ffffff;
      --flash-outline:#0284c7;

      --btn:#111827;
      --btnText:#ffffff;
      --btnSub:#ffffff;
      --danger:#ef4444;

      --radius:14px;
      --shadow:0 8px 24px rgba(16,24,40,.08);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
      overscroll-behavior-y: contain;
      overflow-x:hidden;              /* 横スクロール殺す */
      touch-action: pan-y;            /* 触りは上下だけ */
    }

    /* 画面全体 */
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) 14px calc(80px + env(safe-area-inset-bottom)) 14px;
      gap:12px;
    }

    .topbar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px 12px 10px;
    }
    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    h1{
      font-size:18px;
      line-height:1.2;
      margin:0;
      letter-spacing:.2px;
    }
    .count{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      display:flex;
      gap:10px;
      padding:10px;
      border-bottom:1px solid var(--line);
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      font-weight:700;
      background:var(--btn);
      color:var(--btnText);
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btnSub{
      background:#eef2ff;
      color:#1f2937;
      font-weight:700;
    }
    .btnDanger{
      background:#fee2e2;
      color:#7f1d1d;
      font-weight:800;
    }

    /* 入力用（貼り付け） */
    .pasteWrap{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .pasteLabel{
      font-size:12px;
      color:var(--muted);
    }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      font-size:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* 表（横スクロール無し） */
    .tableWrap{
      overflow:hidden;                /* 横方向のはみ出しを隠す */
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;             /* 横幅固定＝横スクロール出にくい */
    }
    thead th{
      background:var(--head);
      font-size:12px;
      color:#111827;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid var(--line);
      font-size:15px;
      line-height:1.15;
      vertical-align:middle;
      background:#fff;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;             /* まずは折り返さず */
    }
    tbody tr:last-child td{ border-bottom:0; }

    /* 列幅（#は固定、ID/PINは均等） */
    .colNo{ width:52px; }
    .colId{ width:auto; }
    .colPin{ width:auto; }

    /* タップできるセル */
    .tap{
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      border-radius:10px;
    }

    /* コピーしたセルだけ強調（単独） */
    .flash{
      background:var(--flash-bg) !important;
      color:var(--flash-text) !important;
      outline:2px solid var(--flash-outline);
      outline-offset:-2px;
      font-weight:800;
    }

    /* 入力タブで編集できるように見せる（Excelっぽく） */
    .editable{
      background:#fbfdff;
    }
    .editable input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-size:15px;
      padding:0;
      margin:0;
    }
    .editable input::placeholder{
      color:#c0c6d0;
    }

    /* 下タブ */
    .tabs{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background:rgba(246,247,249,.92);
      backdrop-filter:saturate(180%) blur(12px);
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:center;
    }
    .tabBtn{
      flex:1;
      max-width:520px;
      border-radius:16px;
      border:1px solid var(--line);
      padding:12px 12px;
      font-size:15px;
      font-weight:900;
      background:#fff;
      color:#111827;
      cursor:pointer;
    }
    .tabBtn.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    /* コピー完了トースト（濃く） */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(76px + env(safe-area-inset-bottom));
      background:#111827;
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      box-shadow:0 16px 40px rgba(0,0,0,.22);
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
      max-width:min(92vw,520px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    /* セクション表示切り替え */
    .hide{ display:none; }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="titleRow">
        <h1>ID / PIN</h1>
        <div class="count" id="count">件数：0</div>
      </div>
    </div>

    <!-- 入力（編集） -->
    <div class="card" id="viewInput">
      <div class="toolbar">
        <button class="btn" id="btnSave">保存</button>
        <button class="btn btnSub" id="btnLoad">読込</button>
        <button class="btn btnDanger" id="btnClear">全削除</button>
      </div>

      <div class="pasteWrap">
        <div class="pasteLabel">
          ここに「ID<TAB>PIN」を複数行で貼り付け → 「貼り付け反映」<br>
          ※Excel/スプレッドシートからそのままコピペOK
        </div>
        <textarea id="paste" placeholder="例：
VMA1069...	8p7s@...
VMA1070...	t7Sgn..."></textarea>
        <div class="rowBtns">
          <button class="btn" id="btnApply">貼り付け反映</button>
          <button class="btn btnSub" id="btnExport">データをコピー（TSV）</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <colgroup>
            <col class="colNo">
            <col class="colId">
            <col class="colPin">
          </colgroup>
          <thead>
            <tr>
              <th>#</th>
              <th>ID</th>
              <th>PIN</th>
            </tr>
          </thead>
          <tbody id="tbodyInput"></tbody>
        </table>
      </div>
    </div>

    <!-- コピー（閲覧） -->
    <div class="card hide" id="viewCopy">
      <div class="tableWrap">
        <table>
          <colgroup>
            <col class="colNo">
            <col class="colId">
            <col class="colPin">
          </colgroup>
          <thead>
            <tr>
              <th>#</th>
              <th>ID</th>
              <th>PIN</th>
            </tr>
          </thead>
          <tbody id="tbodyCopy"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tabInput">入力</button>
    <button class="tabBtn" id="tabCopy">コピー</button>
  </div>

  <div class="toast" id="toast">コピーしました</div>

  <script>
    // =========================
    // データ（最初は空でOK）
    // =========================
    // 形式: [{id:"...", pin:"..."}, ...]
    let rows = [];

    const LS_KEY = "copy_app_rows_v1";

    const elCount = document.getElementById("count");
    const tbodyInput = document.getElementById("tbodyInput");
    const tbodyCopy  = document.getElementById("tbodyCopy");
    const toast = document.getElementById("toast");

    // ---- UI切替
    const viewInput = document.getElementById("viewInput");
    const viewCopy  = document.getElementById("viewCopy");
    const tabInput  = document.getElementById("tabInput");
    const tabCopy   = document.getElementById("tabCopy");

    tabInput.addEventListener("click", () => switchView("input"));
    tabCopy.addEventListener("click", () => switchView("copy"));

    function switchView(mode){
      const isInput = (mode === "input");
      viewInput.classList.toggle("hide", !isInput);
      viewCopy.classList.toggle("hide", isInput);
      tabInput.classList.toggle("active", isInput);
      tabCopy.classList.toggle("active", !isInput);
      // コピー画面は毎回描画（最新化）
      render();
    }

    // ---- 表描画
    function render(){
      elCount.textContent = `件数：${rows.length}`;

      // 入力テーブル
      tbodyInput.innerHTML = "";
      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        const tdNo = document.createElement("td");
        tdNo.textContent = String(idx + 1);
        tr.appendChild(tdNo);

        const tdId = document.createElement("td");
        tdId.className = "editable";
        const inId = document.createElement("input");
        inId.value = r.id ?? "";
        inId.placeholder = "ID";
        inId.addEventListener("input", () => { rows[idx].id = inId.value; });
        tdId.appendChild(inId);
        tr.appendChild(tdId);

        const tdPin = document.createElement("td");
        tdPin.className = "editable";
        const inPin = document.createElement("input");
        inPin.value = r.pin ?? "";
        inPin.placeholder = "PIN";
        inPin.addEventListener("input", () => { rows[idx].pin = inPin.value; });
        tdPin.appendChild(inPin);
        tr.appendChild(tdPin);

        tbodyInput.appendChild(tr);
      });

      // コピー用テーブル（セルタップ→そのセルだけコピー）
      tbodyCopy.innerHTML = "";
      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        const tdNo = document.createElement("td");
        tdNo.textContent = String(idx + 1);
        tr.appendChild(tdNo);

        const tdId = document.createElement("td");
        tdId.className = "tap";
        tdId.textContent = r.id ?? "";
        tdId.addEventListener("click", () => copyCell(tdId, r.id ?? ""));
        tr.appendChild(tdId);

        const tdPin = document.createElement("td");
        tdPin.className = "tap";
        tdPin.textContent = r.pin ?? "";
        tdPin.addEventListener("click", () => copyCell(tdPin, r.pin ?? ""));
        tr.appendChild(tdPin);

        tbodyCopy.appendChild(tr);
      });
    }

    // ---- コピー処理（iOS Safari対応フォールバック付き）
    async function copyText(text){
      // 空は何もしない
      if (!text) return false;

      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){
        // 後でフォールバック
      }

      // フォールバック：一時テキストエリア
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-1000px";
        ta.style.left = "-1000px";
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(e){
        return false;
      }
    }

    let toastTimer = null;

    async function copyCell(cellEl, text){
      // 既存の強調を全消し（IDとPINが一緒に光らないよう“そのセルだけ”）
      document.querySelectorAll(".flash").forEach(x => x.classList.remove("flash"));

      const ok = await copyText(text);

      // 成功したセルだけ強調
      if (ok){
        cellEl.classList.add("flash");
        showToast(`コピーしました`);
        setTimeout(() => cellEl.classList.remove("flash"), 650);
      }else{
        showToast(`コピー失敗（長押し→コピーで代替）`);
      }
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove("show"), 900);
    }

    // ---- 贴り付け反映（TSV/CSVっぽいの対応）
    document.getElementById("btnApply").addEventListener("click", () => {
      const raw = document.getElementById("paste").value || "";
      const parsed = parsePasted(raw);
      rows = parsed;
      render();
      showToast("反映しました");
    });

    function parsePasted(raw){
      const lines = raw
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n")
        .split("\n")
        .map(s => s.trim())
        .filter(s => s.length > 0);

      const out = [];
      for (const line of lines){
        // タブ優先、なければカンマでも区切れるようにする
        let parts = line.split("\t");
        if (parts.length < 2) parts = line.split(",");
        const id  = (parts[0] ?? "").trim();
        const pin = (parts[1] ?? "").trim();
        if (id || pin) out.push({ id, pin });
      }
      return out;
    }

    // ---- 保存/読込/全削除
    document.getElementById("btnSave").addEventListener("click", () => {
      localStorage.setItem(LS_KEY, JSON.stringify(rows));
      showToast("保存しました");
    });

    document.getElementById("btnLoad").addEventListener("click", () => {
      const s = localStorage.getItem(LS_KEY);
      rows = s ? safeJson(s, []) : [];
      render();
      showToast("読み込みました");
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      rows = [];
      render();
      showToast("全削除しました");
    });

    function safeJson(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }

    // ---- データを書き出し（TSVでコピー）
    document.getElementById("btnExport").addEventListener("click", async () => {
      const tsv = rows.map(r => `${r.id ?? ""}\t${r.pin ?? ""}`).join("\n");
      const ok = await copyText(tsv);
      if (ok) showToast("TSVをコピーしました");
      else showToast("コピー失敗（手動で選択）");
    });

    // 初期表示（初回は空。保存があれば自動読込）
    (function init(){
      const s = localStorage.getItem(LS_KEY);
      if (s){
        rows = safeJson(s, []);
      }else{
        rows = []; // 空でOK
      }
      render();
    })();
  </script>
</body>
</html>
