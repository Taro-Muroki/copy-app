<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ID / PINï¼ˆå…¥åŠ›ï¼†ã‚³ãƒ”ãƒ¼ï¼‰</title>
  <style>
    :root{
      --bg:#f3f5fb;
      --card:#ffffff;
      --line:#e6e9f2;
      --text:#101523;
      --muted:#6b7385;

      --btnDark:#0f1624;
      --btnDarkText:#ffffff;
      --btnLight:#e9edff;

      --dangerBg:#ffe7ea;
      --dangerText:#b1001a;

      --focus:#7a8cff;

      /* ã‚³ãƒ”ãƒ¼æ™‚ã®å¼·èª¿ï¼ˆè–„ã„é’ï¼‰ */
      --flash:#d8ecff;
      --flashOutline:#5aa7ff;

      /* #åˆ— èƒŒæ™¯ã®è–„ã„æ•°å­—ï¼ˆè¦‹ãˆã‚‹ã‚ˆã†ã«å°‘ã—æ¿ƒãï¼‰ */
      --ghostBaseAlpha:0.22; /* â†ã“ã“ãŒã€ŒèƒŒæ™¯ã®æ•°å­—ã®æ¿ƒã•ã€ */
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overscroll-behavior-y: contain;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 120px;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 30;
      padding-top: 10px;
      background: linear-gradient(to bottom, rgba(243,245,251,1), rgba(243,245,251,0.75));
      backdrop-filter: blur(10px);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding: 6px 0 10px;
    }

    .btn{
      border:0;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 2px 0 rgba(0,0,0,0.03);
    }
    .btn.dark{ background:var(--btnDark); color:var(--btnDarkText); }
    .btn.light{ background:var(--btnLight); color: #1a2450; }
    .btn.danger{ background:var(--dangerBg); color:var(--dangerText); }

    .btn.icon{
      width: 44px;
      padding: 10px 0;
      font-weight: 900;
    }

    .card{
      background:var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(10,20,60,0.06);
    }

    .section{
      padding: 14px;
      margin-top: 12px;
    }

    .headerRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .hTitle{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .count{
      font-size: 14px;
      color: var(--muted);
      font-weight: 800;
    }

    .help{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      margin: 6px 0 10px;
    }

    .pasteBox{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      font-size: 15px;
      line-height: 1.35;
      min-height: 92px;
      resize: vertical;
      outline: none;
      background: #fbfcff;
    }
    .pasteBox:focus{
      border-color: rgba(122,140,255,0.8);
      box-shadow: 0 0 0 4px rgba(122,140,255,0.18);
    }

    .pasteActions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .pasteActions .btn{
      flex:1;
      padding: 14px 14px;
      border-radius: 18px;
      font-size: 16px;
    }

    .grid{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: #fff;
    }

    .gridHeader, .gridRow{
      display:grid;
      grid-template-columns: 44px 1fr 0.78fr; /* #æœ€ç‹­ / IDæœ€åºƒ / PINæ¬¡ã«åºƒã„ */
      align-items:center;
      column-gap: 10px;
      padding: 12px 12px;
    }

    .gridHeader{
      background: #f1f3f7;
      border-bottom: 1px solid var(--line);
      font-weight: 900;
      color: #2b3245;
      letter-spacing: .2px;
    }

    .gridRow{
      border-bottom: 1px solid var(--line);
      position: relative;
      background: #fff;
    }
    .gridRow:last-child{ border-bottom: 0; }

    .numCell{
      position: relative;
      height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: #1a2236;
    }
    .numGhost{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      font-size: 28px;
      letter-spacing: -1px;
      opacity: 1;
      pointer-events:none;
      transform: translateY(1px);
    }
    .numFront{
      position:relative;
      z-index:2;
      font-size: 13px;
      opacity: .9;
    }

    .cellWrap{
      position: relative;
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .cellInput{
      width:100%;
      border: 1px solid transparent;
      background: transparent;
      outline:none;
      padding: 10px 44px 10px 10px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      min-width: 0;
    }
    .cellInput:focus{
      background: #f7f9ff;
      border-color: rgba(122,140,255,0.75);
      box-shadow: 0 0 0 4px rgba(122,140,255,0.18);
    }

    .copyMini{
      position:absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid #cfd7ff;
      background: #eef2ff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      cursor:pointer;
      user-select:none;
    }

    .tapCell{
      padding: 10px 10px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      user-select: none;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor:pointer;
      min-width: 0;
    }
    .tapCell:active{
      transform: scale(0.995);
    }

    .flash{
      background: var(--flash) !important;
      outline: 2px solid var(--flashOutline);
      outline-offset: -2px;
    }

    .tabs{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 40;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(243,245,251,1), rgba(243,245,251,0.6));
      backdrop-filter: blur(10px);
    }
    .tabBar{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap: 12px;
    }
    .tabBtn{
      flex:1;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px 0;
      font-weight: 950;
      font-size: 18px;
      cursor:pointer;
      background: #fff;
    }
    .tabBtn.active{
      background: var(--btnDark);
      color: #fff;
      border-color: rgba(0,0,0,0);
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(88px + env(safe-area-inset-bottom));
      background: rgba(15,22,36,0.92);
      color:#fff;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 14px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 60;
    }
    .toast.show{ opacity: 1; }

    /* å…¥åŠ›ã‚·ãƒ¼ãƒˆã ã‘å°ã•ã‚ï¼ˆã“ã“ã¯å‰ã®ã¾ã¾ï¼‰ */
    .view-input .gridRow,
    .view-input .gridHeader{
      font-size: 15px;
    }
    .view-input .cellInput{
      font-size: 15px;
    }
    .view-copy .gridRow,
    .view-copy .gridHeader{
      font-size: 18px;
    }
    .view-copy .tapCell{
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="controls">
        <button class="btn dark" id="btnSave">ä¿å­˜</button>
        <button class="btn light" id="btnLoad">èª­è¾¼</button>
        <button class="btn danger" id="btnClear">å…¨å‰Šé™¤</button>

        <div style="flex:1"></div>

        <button class="btn icon light" id="btnBack" title="æˆ»ã‚‹">â†</button>
        <button class="btn icon light" id="btnFwd" title="é€²ã‚€">â†’</button>
      </div>
    </div>

    <!-- å…¥åŠ›ãƒ“ãƒ¥ãƒ¼ -->
    <div id="viewInput" class="card section view-input" style="display:none;">
      <div class="headerRow">
        <div class="hTitle">å…¥åŠ›</div>
        <div class="count">ä»¶æ•°ï¼š<span id="countInput">0</span></div>
      </div>

      <div class="help">
        ã“ã“ã«ã€ŒID PINã€ã‚’è¤‡æ•°è¡Œã§è²¼ã‚Šä»˜ã‘ â†’ ã€Œè²¼ã‚Šä»˜ã‘åæ˜ ã€<br/>
        ï¼ˆExcel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãã®ã¾ã¾ã‚³ãƒ”ãƒšOKï¼‰
      </div>

      <textarea id="pasteArea" class="pasteBox" placeholder="ä¾‹ï¼šVMA1069413711 8p7s@3WD"></textarea>

      <div class="pasteActions">
        <button class="btn dark" id="btnApply">è²¼ã‚Šä»˜ã‘åæ˜ </button>
        <button class="btn light" id="btnCopyTSV">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆTSVï¼‰</button>
      </div>

      <div style="height:12px"></div>

      <div class="headerRow" style="margin-bottom:10px;">
        <div class="hTitle" style="font-size:18px;">ID / PIN</div>
        <div class="count">ä»¶æ•°ï¼š<span id="countTableInput">0</span></div>
      </div>

      <div class="grid" id="gridInput">
        <div class="gridHeader">
          <div>#</div>
          <div>ID</div>
          <div>PIN</div>
        </div>
        <div id="rowsInput"></div>
      </div>
    </div>

    <!-- ã‚³ãƒ”ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
    <div id="viewCopy" class="card section view-copy" style="display:none;">
      <div class="headerRow">
        <div class="hTitle">ã‚³ãƒ”ãƒ¼</div>
        <div class="count">ä»¶æ•°ï¼š<span id="countCopy">0</span></div>
      </div>

      <div class="help" style="margin-bottom:12px;">
        ã‚»ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®ã‚»ãƒ«ã®æ–‡å­—ã ã‘ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
      </div>

      <div class="grid" id="gridCopy">
        <div class="gridHeader">
          <div>#</div>
          <div>ID</div>
          <div>PIN</div>
        </div>
        <div id="rowsCopy"></div>
      </div>
    </div>

  </div>

  <div class="tabs">
    <div class="tabBar">
      <button class="tabBtn" id="tabInput">å…¥åŠ›</button>
      <button class="tabBtn" id="tabCopy">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /***************
     * çŠ¶æ…‹
     ***************/
    const STORAGE_KEY = "idpin_app_v1";
    const MAX_ROWS = 120;

    // row: { id, pin, editCount, lastCountedId }
    let rows = [];

    // å±¥æ­´ï¼ˆæˆ»ã‚‹/é€²ã‚€ï¼‰
    let history = [];
    let histIdx = -1;

    // UI refs
    const viewInput = document.getElementById("viewInput");
    const viewCopy  = document.getElementById("viewCopy");
    const tabInput  = document.getElementById("tabInput");
    const tabCopy   = document.getElementById("tabCopy");

    const btnSave   = document.getElementById("btnSave");
    const btnLoad   = document.getElementById("btnLoad");
    const btnClear  = document.getElementById("btnClear");
    const btnBack   = document.getElementById("btnBack");
    const btnFwd    = document.getElementById("btnFwd");

    const pasteArea = document.getElementById("pasteArea");
    const btnApply  = document.getElementById("btnApply");
    const btnCopyTSV= document.getElementById("btnCopyTSV");

    const rowsInput = document.getElementById("rowsInput");
    const rowsCopy  = document.getElementById("rowsCopy");

    const countInput = document.getElementById("countInput");
    const countCopy  = document.getElementById("countCopy");
    const countTableInput = document.getElementById("countTableInput");

    const toast = document.getElementById("toast");

    /***************
     * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     ***************/
    function showToast(msg="ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 900);
    }

    function clampRows(){
      if(rows.length > MAX_ROWS) rows = rows.slice(0, MAX_ROWS);
    }

    function ensureRow(i){
      while(rows.length <= i){
        rows.push({ id:"", pin:"", editCount:0, lastCountedId:"" });
      }
    }

    function snapshot(){
      const snap = JSON.stringify(rows);
      if(histIdx >= 0 && history[histIdx] === snap) return;
      history = history.slice(0, histIdx + 1);
      history.push(snap);
      histIdx = history.length - 1;
      updateHistBtns();
    }

    function restoreFromHistory(targetIdx){
      if(targetIdx < 0 || targetIdx >= history.length) return;
      histIdx = targetIdx;
      rows = JSON.parse(history[histIdx]);
      renderAll();
      updateHistBtns();
    }

    function updateHistBtns(){
      btnBack.disabled = (histIdx <= 0);
      btnFwd.disabled  = (histIdx >= history.length - 1);
      btnBack.style.opacity = btnBack.disabled ? 0.4 : 1;
      btnFwd.style.opacity  = btnFwd.disabled  ? 0.4 : 1;
    }

    function nonEmptyCount(){
      return rows.filter(r => (r.id && r.id.trim()) || (r.pin && r.pin.trim())).length;
    }

    function toTSV(){
      const lines = rows
        .filter(r => (r.id && r.id.trim()) || (r.pin && r.pin.trim()))
        .map(r => `${r.id ?? ""}\t${r.pin ?? ""}`);
      return lines.join("\n");
    }

    async function writeClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        }catch(_){
          return false;
        }
      }
    }

    function flashEl(el){
      el.classList.add("flash");
      clearTimeout(el._flashT);
      el._flashT = setTimeout(()=>el.classList.remove("flash"), 520);
    }

    function colorForCount(n){
      const hue = (n * 37) % 360;
      const a = getComputedStyle(document.documentElement).getPropertyValue("--ghostBaseAlpha").trim() || "0.22";
      return `hsla(${hue}, 70%, 45%, ${a})`;
    }

    /***************
     * æç”»
     ***************/
    function renderAll(){
      renderInputTable();
      renderCopyTable();
      countInput.textContent = String(nonEmptyCount());
      countTableInput.textContent = String(nonEmptyCount());
      countCopy.textContent = String(nonEmptyCount());
    }

    function renderInputTable(){
      rowsInput.innerHTML = "";
      const count = rows.length;
      for(let i=0;i<Math.max(count, 1);i++){
        ensureRow(i);
        const r = rows[i];

        const rowEl = document.createElement("div");
        rowEl.className = "gridRow";

        const num = document.createElement("div");
        num.className = "numCell";

        const ghost = document.createElement("div");
        ghost.className = "numGhost";
        ghost.textContent = String(r.editCount ?? 0);
        ghost.style.color = colorForCount(r.editCount ?? 0);

        const front = document.createElement("div");
        front.className = "numFront";
        front.textContent = String(i+1);

        num.appendChild(ghost);
        num.appendChild(front);

        // IDï¼ˆ13æ–‡å­—ã¾ã§ï¼šè‹±æ•°å­—ãªã©OKï¼‰
        const idWrap = document.createElement("div");
        idWrap.className = "cellWrap";
        const idInput = document.createElement("input");
        idInput.className = "cellInput";
        idInput.value = r.id ?? "";
        idInput.autocomplete = "off";
        idInput.spellcheck = false;

        // â˜…è‹±æ•°å­—OKã®ã¾ã¾ã€é•·ã•ã ã‘13ã«åˆ¶é™
        idInput.maxLength = 13;

        const idCopy = document.createElement("button");
        idCopy.type = "button";
        idCopy.className = "copyMini";
        idCopy.textContent = "ğŸ“‹";
        idCopy.title = "IDã‚’ã‚³ãƒ”ãƒ¼";

        // PINï¼ˆ8æ–‡å­—ã¾ã§ï¼‰
        const pinWrap = document.createElement("div");
        pinWrap.className = "cellWrap";
        const pinInput = document.createElement("input");
        pinInput.className = "cellInput";
        pinInput.value = r.pin ?? "";
        pinInput.autocomplete = "off";
        pinInput.spellcheck = false;
        pinInput.maxLength = 8;

        const pinCopy = document.createElement("button");
        pinCopy.type = "button";
        pinCopy.className = "copyMini";
        pinCopy.textContent = "ğŸ“‹";
        pinCopy.title = "PINã‚’ã‚³ãƒ”ãƒ¼";

        function enableAutoSelectAll(inp){
          inp.addEventListener("pointerdown", ()=>{
            requestAnimationFrame(()=>{
              try{ inp.focus({preventScroll:true}); }catch(_){}
              setTimeout(()=>{ try{ inp.select(); }catch(_){} }, 0);
            });
          }, {passive:true});

          inp.addEventListener("focus", ()=>{
            setTimeout(()=>{ try{ inp.select(); }catch(_){} }, 0);
          });
        }
        enableAutoSelectAll(idInput);
        enableAutoSelectAll(pinInput);

        // IDç·¨é›†ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå€¤ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘ +1ã€‚åŒã˜å€¤ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ï¼‰
        let idStartValue = r.id ?? "";
        idInput.addEventListener("focus", ()=>{
          idStartValue = idInput.value ?? "";
        });

        // rowsã¸ã¯å³åæ˜ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹è‰¯ãï¼‰
        idInput.addEventListener("input", ()=>{
          r.id = (idInput.value ?? "").slice(0,13);
        });

        idInput.addEventListener("blur", ()=>{
          const newVal = (idInput.value ?? "").slice(0,13);
          r.id = newVal;

          if(newVal !== idStartValue){
            if((r.lastCountedId ?? "") !== newVal){
              r.editCount = (r.editCount ?? 0) + 1;
              r.lastCountedId = newVal;
              ghost.textContent = String(r.editCount);
              ghost.style.color = colorForCount(r.editCount);
            }
            snapshot();
            renderCopyTable();
            countInput.textContent = String(nonEmptyCount());
            countTableInput.textContent = String(nonEmptyCount());
            countCopy.textContent = String(nonEmptyCount());
          }
        });

        pinInput.addEventListener("input", ()=>{
          r.pin = (pinInput.value ?? "").slice(0,8);
        });
        pinInput.addEventListener("blur", ()=>{
          r.pin = (pinInput.value ?? "").slice(0,8);
          snapshot();
          renderCopyTable();
          countInput.textContent = String(nonEmptyCount());
          countTableInput.textContent = String(nonEmptyCount());
          countCopy.textContent = String(nonEmptyCount());
        });

        idCopy.addEventListener("click", async ()=>{
          const ok = await writeClipboard(r.id ?? "");
          if(ok){
            flashEl(idInput);
            showToast("IDã‚’ã‚³ãƒ”ãƒ¼");
          }
        });
        pinCopy.addEventListener("click", async ()=>{
          const ok = await writeClipboard(r.pin ?? "");
          if(ok){
            flashEl(pinInput);
            showToast("PINã‚’ã‚³ãƒ”ãƒ¼");
          }
        });

        idWrap.appendChild(idInput);
        idWrap.appendChild(idCopy);

        pinWrap.appendChild(pinInput);
        pinWrap.appendChild(pinCopy);

        rowEl.appendChild(num);
        rowEl.appendChild(idWrap);
        rowEl.appendChild(pinWrap);

        rowsInput.appendChild(rowEl);
      }
    }

    function renderCopyTable(){
      rowsCopy.innerHTML = "";
      const filtered = rows
        .map((r,idx)=>({r,idx}))
        .filter(x => (x.r.id && x.r.id.trim()) || (x.r.pin && x.r.pin.trim()));

      if(filtered.length === 0){
        const rowEl = document.createElement("div");
        rowEl.className = "gridRow";
        rowEl.innerHTML = `
          <div class="numCell"><div class="numGhost" style="color:${colorForCount(0)}">0</div><div class="numFront">-</div></div>
          <div class="tapCell" style="color:#a0a7ba;">ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</div>
          <div class="tapCell"></div>
        `;
        rowsCopy.appendChild(rowEl);
        return;
      }

      for(let i=0;i<filtered.length;i++){
        const {r} = filtered[i];

        const rowEl = document.createElement("div");
        rowEl.className = "gridRow";

        const num = document.createElement("div");
        num.className = "numCell";

        const ghost = document.createElement("div");
        ghost.className = "numGhost";
        ghost.textContent = String(r.editCount ?? 0);
        ghost.style.color = colorForCount(r.editCount ?? 0);

        const front = document.createElement("div");
        front.className = "numFront";
        front.textContent = String(i+1);

        num.appendChild(ghost);
        num.appendChild(front);

        const idCell = document.createElement("div");
        idCell.className = "tapCell";
        idCell.textContent = r.id ?? "";

        const pinCell = document.createElement("div");
        pinCell.className = "tapCell";
        pinCell.textContent = r.pin ?? "";

        idCell.addEventListener("click", async ()=>{
          const ok = await writeClipboard(r.id ?? "");
          if(ok){
            flashEl(idCell);
            showToast("IDã‚’ã‚³ãƒ”ãƒ¼");
          }
        });
        pinCell.addEventListener("click", async ()=>{
          const ok = await writeClipboard(r.pin ?? "");
          if(ok){
            flashEl(pinCell);
            showToast("PINã‚’ã‚³ãƒ”ãƒ¼");
          }
        });

        rowEl.appendChild(num);
        rowEl.appendChild(idCell);
        rowEl.appendChild(pinCell);

        rowsCopy.appendChild(rowEl);
      }
    }

    /***************
     * å…¥åŠ› â†’ åæ˜ 
     ***************/
    function stripPrefix(line, label){
      // label: "ã‚¢ãƒ—ãƒªID" / "PIN"
      // "ã‚¢ãƒ—ãƒªID:" "ã‚¢ãƒ—ãƒªIDï¼š" "ã‚¢ãƒ—ãƒªID : " ãªã©ã‚’è¨±å®¹
      const re = new RegExp("^\\s*" + label + "\\s*[:ï¼š]\\s*", "i");
      return line.replace(re, "").trim();
    }

    function isAppIdLine(line){
      return /^\s*ã‚¢ãƒ—ãƒªID\s*[:ï¼š]/i.test(line) || /^\s*AppID\s*[:ï¼š]/i.test(line);
    }
    function isPinLine(line){
      return /^\s*PIN\s*[:ï¼š]/i.test(line);
    }

    function parsePasted(text){
      const lines = (text ?? "")
        .split(/\r?\n/)
        .map(s=>s.trim())
        .filter(Boolean);

      const out = [];

      for(let i=0;i<lines.length;i++){
        const line = lines[i];

        // ===== ä¾‹å¤–ï¼š2è¡Œè¡¨è¨˜ï¼ˆã‚¢ãƒ—ãƒªID:... / PIN:...ï¼‰ã‚’1ä»¶ã«ã¾ã¨ã‚ã‚‹ =====
        if(isAppIdLine(line) && (i+1) < lines.length && isPinLine(lines[i+1])){
          const id = stripPrefix(line, line.match(/^\s*AppID/i) ? "AppID" : "ã‚¢ãƒ—ãƒªID").slice(0,13);
          const pin = stripPrefix(lines[i+1], "PIN").slice(0,8);
          out.push({id, pin});
          i++; // æ¬¡ã®PINè¡Œã‚’æ¶ˆè²»
          continue;
        }

        // ===== ãã‚Œä»¥å¤–ï¼šå¾“æ¥ãƒ«ãƒ¼ãƒ«ï¼ˆ1è¡Œï¼ID PINï¼‰ =====
        const parts = line.split(/\s+/);
        if(parts.length === 1){
          out.push({id: parts[0].slice(0,13), pin:""});
        }else{
          out.push({id: (parts[0] ?? "").slice(0,13), pin: (parts[1] ?? "").slice(0,8)});
        }
      }

      return out;
    }

    btnApply.addEventListener("click", ()=>{
      const pasted = parsePasted(pasteArea.value);

      if(pasted.length === 0){
        showToast("è²¼ã‚Šä»˜ã‘ãƒ‡ãƒ¼ã‚¿ãªã—");
        return;
      }

      for(let i=0;i<pasted.length;i++){
        ensureRow(i);

        const id  = (pasted[i].id ?? "").slice(0,13);
        const pin = (pasted[i].pin ?? "").slice(0,8);

        rows[i].id = id;
        rows[i].pin = pin;

        if((rows[i].lastCountedId ?? "") === ""){
          rows[i].lastCountedId = id;
        }
      }
      clampRows();
      snapshot();
      renderAll();
      showToast("åæ˜ ã—ã¾ã—ãŸ");
    });

    btnCopyTSV.addEventListener("click", async ()=>{
      const tsv = toTSV();
      if(!tsv){
        showToast("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã—");
        return;
      }
      const ok = await writeClipboard(tsv);
      if(ok) showToast("TSVã‚³ãƒ”ãƒ¼");
    });

    /***************
     * ä¿å­˜/èª­è¾¼/å…¨å‰Šé™¤
     ***************/
    btnSave.addEventListener("click", ()=>{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      showToast("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    btnLoad.addEventListener("click", ()=>{
      const s = localStorage.getItem(STORAGE_KEY);
      if(!s){
        showToast("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");
        return;
      }
      try{
        rows = JSON.parse(s);
        if(!Array.isArray(rows)) rows = [];
        snapshot();
        renderAll();
        showToast("èª­è¾¼ã—ã¾ã—ãŸ");
      }catch(e){
        showToast("èª­è¾¼å¤±æ•—");
      }
    });

    btnClear.addEventListener("click", ()=>{
      if(!confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        return;
      }
      rows = [];
      pasteArea.value = "";
      history = [];
      histIdx = -1;
      snapshot();
      renderAll();
      showToast("å…¨å‰Šé™¤ã—ã¾ã—ãŸ");
    });

    /***************
     * æˆ»ã‚‹/é€²ã‚€
     ***************/
    btnBack.addEventListener("click", ()=> restoreFromHistory(histIdx - 1));
    btnFwd.addEventListener("click",  ()=> restoreFromHistory(histIdx + 1));

    /***************
     * ã‚¿ãƒ–åˆ‡æ›¿
     ***************/
    function setTab(which){
      const isInput = (which === "input");
      viewInput.style.display = isInput ? "" : "none";
      viewCopy.style.display  = isInput ? "none" : "";
      tabInput.classList.toggle("active", isInput);
      tabCopy.classList.toggle("active", !isInput);
    }
    tabInput.addEventListener("click", ()=> setTab("input"));
    tabCopy.addEventListener("click",  ()=> setTab("copy"));

    /***************
     * åˆæœŸåŒ–
     ***************/
    function init(){
      const s = localStorage.getItem(STORAGE_KEY);
      if(s){
        try{
          const loaded = JSON.parse(s);
          if(Array.isArray(loaded)) rows = loaded;
        }catch(_){}
      }
      snapshot();
      renderAll();
      setTab("input");
    }
    init();
  </script>
</body>
</html>
